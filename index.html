<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Quest Board"/>
<meta name="theme-color" content="#C8B89A"/>
<title>Quest Board</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&family=IM+Fell+English&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --space:#C8B89A;--deep:#BEA882;--hull:#D4C4A8;--panel:#E0D0B4;--border:#A08060;--border2:#8A6A48;
  --gold:#7A4A10;--gold2:#5C3408;--gold-dim:#3E2005;
  --saber-blue:#1A4A8A;--saber-green:#1A5C28;--saber-red:#7A1818;--saber-purple:#4A2878;
  --text:#2A1A08;--text2:#4A3018;--text3:#6A5030;--text4:#8A7050;
  --crawl:#D4A017;
  --font-hud:'Cinzel',serif;
  --font-data:'IM Fell English','Georgia',serif;
  --scanline: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(80,50,20,0.04) 3px,rgba(80,50,20,0.04) 6px);
}

/* STARFIELD */
html,body{
  height:100%;overflow:hidden;
  background:#C8B89A;
  color:var(--text);
  font-family:var(--font-data);
  font-size:16px;
}
body::before{
  content:'';position:fixed;inset:0;
  background-image:
    radial-gradient(ellipse at 20% 20%, rgba(212,160,23,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(139,105,20,0.04) 0%, transparent 50%),
    repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(74,55,40,0.03) 40px, rgba(74,55,40,0.03) 41px),
    repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(74,55,40,0.02) 40px, rgba(74,55,40,0.02) 41px);
  pointer-events:none;
  z-index:0;
}
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:
    radial-gradient(ellipse at 10% 90%, rgba(120,80,30,0.20) 0%, transparent 40%),
    radial-gradient(ellipse at 90% 90%, rgba(120,80,30,0.18) 0%, transparent 40%);
}
</style>
<style>
/* DUNGEON AMBIANCE ‚Äî rune glow orbs, animated torch flicker */
@keyframes torchFlicker{
  0%,100%{opacity:1;}
  20%{opacity:0.85;}
  40%{opacity:0.95;}
  60%{opacity:0.80;}
  80%{opacity:0.92;}
}
@keyframes runeGlow{
  0%,100%{opacity:0.18;transform:scale(1);}
  50%{opacity:0.32;transform:scale(1.08);}
}
@keyframes smokeRise{
  0%{transform:translateY(0) scaleX(1);opacity:0.06;}
  100%{transform:translateY(-120px) scaleX(1.6);opacity:0;}
}
#dungeon-bg{
  position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;
}
/* Torch glow spots ‚Äî corners */
#dungeon-bg .torch{
  position:absolute;width:180px;height:260px;border-radius:50%;
  animation:torchFlicker 3s ease-in-out infinite;
}
#dungeon-bg .torch-tl{top:-60px;left:-60px;background:radial-gradient(ellipse,rgba(255,200,80,0.35) 0%,rgba(220,140,40,0.15) 45%,transparent 70%);animation-delay:0s;}
#dungeon-bg .torch-tr{top:-60px;right:-60px;background:radial-gradient(ellipse,rgba(255,200,80,0.30) 0%,rgba(220,140,40,0.12) 45%,transparent 70%);animation-delay:0.7s;}
#dungeon-bg .torch-bl{bottom:-40px;left:-40px;background:radial-gradient(ellipse,rgba(240,170,60,0.25) 0%,transparent 65%);animation-delay:1.3s;}
#dungeon-bg .torch-br{bottom:-40px;right:-40px;background:radial-gradient(ellipse,rgba(240,170,60,0.22) 0%,transparent 65%);animation-delay:1.9s;}
/* Arcane rune glows */
#dungeon-bg .rune{
  position:absolute;border-radius:50%;
  animation:runeGlow 6s ease-in-out infinite;
}
#dungeon-bg .rune-1{width:300px;height:300px;top:20%;left:-80px;background:radial-gradient(ellipse,rgba(74,40,120,0.12) 0%,transparent 65%);animation-delay:0s;}
#dungeon-bg .rune-2{width:250px;height:250px;bottom:30%;right:-60px;background:radial-gradient(ellipse,rgba(26,74,138,0.10) 0%,transparent 65%);animation-delay:2s;}
#dungeon-bg .rune-3{width:200px;height:200px;top:55%;left:40%;background:radial-gradient(ellipse,rgba(107,63,160,0.08) 0%,transparent 65%);animation-delay:4s;}
/* Stone vignette ‚Äî darken edges */
#dungeon-bg .vignette{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 30%, transparent 45%, rgba(80,52,24,0.25) 100%);
}
/* Crack texture overlay ‚Äî subtle diagonal lines */
#dungeon-bg .cracks{
  position:absolute;inset:0;opacity:0.12;
  background-image:
    repeating-linear-gradient(17deg, transparent, transparent 38px, rgba(80,52,24,0.5) 38px, rgba(80,52,24,0.5) 39px),
    repeating-linear-gradient(-31deg, transparent, transparent 55px, rgba(80,52,24,0.3) 55px, rgba(80,52,24,0.3) 56px);
}
/* Ambient mid-screen glow */
#dungeon-bg .midglow{
  position:absolute;width:100%;height:50%;top:25%;
  background:radial-gradient(ellipse at 50% 50%, rgba(212,160,23,0.04) 0%, transparent 70%);
  animation:torchFlicker 5s ease-in-out infinite;animation-delay:2.5s;
}
</style>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Quest Board"/>
<meta name="theme-color" content="#C8B49A"/>
<title>Quest Board</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&family=IM+Fell+English&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --space:#C8B89A;--deep:#BEA882;--hull:#D4C4A8;--panel:#E0D0B4;--border:#A08060;--border2:#8A6A48;
  --gold:#7A4A10;--gold2:#5C3408;--gold-dim:#3E2005;
  --saber-blue:#1A4A8A;--saber-green:#1A5C28;--saber-red:#7A1818;--saber-purple:#4A2878;
  --text:#2A1A08;--text2:#4A3018;--text3:#6A5030;--text4:#8A7050;
  --crawl:#D4A017;
  --font-hud:'Cinzel',serif;
  --font-data:'IM Fell English','Georgia',serif;
  --scanline: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(80,50,20,0.04) 3px,rgba(80,50,20,0.04) 6px);
}

/* STARFIELD */
html,body{
  height:100%;overflow:hidden;
  background:var(--space);
  color:var(--text);
  font-family:var(--font-data);
  font-size:16px;
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:
    /* Stone block grid ‚Äî horizontal lines */
    repeating-linear-gradient(0deg, transparent, transparent 47px, rgba(100,72,40,0.18) 47px, rgba(100,72,40,0.18) 49px),
    /* Stone block grid ‚Äî vertical, offset every other row */
    repeating-linear-gradient(90deg, transparent, transparent 59px, rgba(100,72,40,0.12) 59px, rgba(100,72,40,0.12) 61px),
    /* Warm light from top ‚Äî simulates window/sky light */
    radial-gradient(ellipse at 50% -10%, rgba(255,230,160,0.45) 0%, rgba(220,185,110,0.15) 40%, transparent 70%),
    /* Subtle variation across surface */
    radial-gradient(ellipse at 20% 60%, rgba(180,145,90,0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 40%, rgba(210,175,110,0.12) 0%, transparent 50%);
}
#app{display:flex;flex-direction:column;height:100%;height:100dvh;position:relative;z-index:1;}

/* scanlines removed for light theme */

/* HEADER */
#header{
  background:linear-gradient(180deg,rgba(176,148,100,0.98) 0%,rgba(196,165,115,0.97) 100%);
  box-shadow:0 2px 12px rgba(80,52,24,0.35),0 1px 0 rgba(90,58,20,0.4);
  border-bottom:2px solid rgba(90,58,20,0.5);
  padding:0 14px;
  padding-top:env(safe-area-inset-top);
  min-height:62px;
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
  box-shadow:0 2px 20px rgba(255,215,0,0.1);
  position:relative;
}
#header::before{
  content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold),var(--gold2),var(--gold),transparent);
}
#header-brand{display:flex;flex-direction:column;}
#header-title{
  font-family:var(--font-hud);font-size:18px;font-weight:900;
  color:var(--gold);letter-spacing:3px;text-transform:uppercase;
  text-shadow:1px 1px 0 rgba(255,240,180,0.8),0 0 12px rgba(180,120,20,0.4);
}
#header-sub{font-size:10px;color:var(--text3);letter-spacing:2px;margin-top:1px;font-family:var(--font-hud);}
#header-stats{font-size:11px;color:var(--text3);margin-top:2px;letter-spacing:0.5px;}
#header-actions{display:flex;gap:5px;align-items:center;}

.hbtn{
  background:rgba(200,168,112,0.35);
  border:1px solid rgba(140,100,50,0.55);
  color:var(--text);
  padding:5px 9px;border-radius:4px;cursor:pointer;
  font-family:var(--font-hud);font-size:12px;font-weight:700;
  letter-spacing:1px;white-space:nowrap;
  transition:all 0.15s;outline:none;
  text-shadow:0 0 6px rgba(255,215,0,0.3);
}
.hbtn:active{background:rgba(160,120,60,0.3);transform:scale(0.96);}
.hbtn.primary{background:rgba(122,74,16,0.18);border-color:var(--gold);color:var(--gold);}
.hbtn.engaged{background:rgba(92,138,60,0.1);border-color:var(--saber-green);color:var(--saber-green);text-shadow:0 0 8px rgba(92,138,60,0.5);}

/* GUILD ARCHIVE SYNC BAR */
#sync-bar{
  background:rgba(196,172,128,0.97);
  border-bottom:1px solid rgba(140,100,50,0.3);
  padding:3px 14px;display:flex;align-items:center;gap:6px;flex-shrink:0;
}
#sync-dot{width:6px;height:6px;border-radius:50%;background:#C87820;flex-shrink:0;
  box-shadow:0 0 8px #C87820,0 0 14px rgba(200,120,32,0.4);transition:all 0.3s;}
#sync-dot.syncing{background:var(--gold);box-shadow:0 0 6px var(--gold);animation:pulse 1s infinite;}
#sync-dot.error{background:var(--saber-red);box-shadow:0 0 6px var(--saber-red);}
#sync-dot.offline{background:var(--text4);box-shadow:none;}
#sync-label{font-size:11px;color:var(--text3);letter-spacing:1px;font-family:var(--font-hud);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

/* TACTICAL FILTER BAR */
#filter-bar{
  background:rgba(224,208,176,0.97);
  border-bottom:1px solid var(--border);
  padding:7px 10px;display:flex;gap:4px;align-items:center;
  overflow-x:auto;flex-shrink:0;scrollbar-width:none;
}
#filter-bar::-webkit-scrollbar{display:none;}
.fbtn{
  background:rgba(200,168,112,0.4);border:1px solid rgba(140,100,50,0.4);color:var(--text2);
  padding:4px 9px;border-radius:2px;cursor:pointer;font-size:10px;
  font-family:var(--font-hud);font-weight:700;letter-spacing:1px;
  white-space:nowrap;transition:all 0.15s;outline:none;flex-shrink:0;
  text-transform:uppercase;
}
.fbtn.active-work{background:rgba(26,74,138,0.15);border-color:#1A4A8A;color:#1A4A8A;}
.fbtn.active-all{background:rgba(122,74,16,0.15);border-color:var(--gold);color:var(--gold);}
.fbtn.active-personal{background:rgba(26,92,40,0.15);border-color:#1A5C28;color:#1A5C28;}
.fbtn.active-status{background:rgba(122,74,16,0.15);border-color:var(--gold);color:var(--gold);}
.fbtn.active-view{background:rgba(26,74,138,0.15);border-color:#1A4A8A;color:#1A4A8A;}
.filter-sep{width:1px;height:18px;background:var(--border2);flex-shrink:0;margin:0 2px;}

/* MAIN */
#main{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:10px;}
#main::-webkit-scrollbar{width:2px;}
#main::-webkit-scrollbar-thumb{background:var(--gold2);border-radius:1px;}

/* SEARCH */
#search-bar{background:rgba(204,180,136,0.97);border-bottom:1px solid var(--border);padding:7px 12px;flex-shrink:0;display:none;}
#search-bar.visible{display:block;}
#search-input{
  background:rgba(252,240,210,0.95);border:1px solid rgba(140,100,50,0.45);color:var(--text);
  padding:8px 12px;border-radius:3px;font-family:var(--font-hud);font-size:12px;
  letter-spacing:1px;outline:none;width:100%;
}
#search-input::placeholder{color:var(--text3);}

/* PARTY CARDS (projects) */
.project-card{
  background:linear-gradient(135deg,rgba(232,212,172,0.97) 0%,rgba(220,196,152,0.99) 100%);
  border:1px solid rgba(140,100,50,0.4);
  border-left:4px solid var(--gold);
  box-shadow:0 2px 8px rgba(80,52,24,0.2),inset 0 1px 0 rgba(255,240,200,0.5);
  border-radius:3px;margin-bottom:10px;overflow:hidden;
  box-shadow:inset 0 0 20px rgba(0,0,50,0.3);
}
.project-header{
  display:flex;align-items:center;gap:10px;padding:11px 13px;
  cursor:pointer;
  background:linear-gradient(90deg,rgba(255,215,0,0.04) 0%,transparent 100%);
  -webkit-user-select:none;user-select:none;
  transition:background 0.15s;
}
.project-header:active{background:rgba(255,215,0,0.08);}
.project-chevron{font-size:10px;flex-shrink:0;transition:transform 0.2s;color:var(--gold2);}
.project-chevron.open{transform:rotate(0deg);}
.project-chevron.closed{transform:rotate(-90deg);}
.project-info{flex:1;min-width:0;}
.project-name{font-family:var(--font-hud);font-weight:700;font-size:14px;letter-spacing:1.5px;text-transform:uppercase;}
.project-meta{display:flex;align-items:center;gap:6px;margin-top:4px;}
.domain-pill{font-size:10px;padding:2px 7px;border-radius:2px;letter-spacing:1px;flex-shrink:0;font-family:var(--font-hud);font-weight:700;}
.progress-bar-wrap{flex:1;height:2px;background:var(--border);border-radius:1px;}
.progress-bar-fill{height:100%;border-radius:1px;transition:width 0.4s;}
.progress-count{font-size:10px;color:var(--text3);flex-shrink:0;font-family:var(--font-hud);}
.add-task-btn{
  background:transparent;border:1px solid;padding:3px 8px;border-radius:2px;
  cursor:pointer;font-size:9px;font-family:var(--font-hud);font-weight:700;letter-spacing:1px;
  flex-shrink:0;transition:all 0.15s;outline:none;text-transform:uppercase;
}
.add-task-btn:active{opacity:0.7;}

/* QUEST ROWS (tasks) */
.task-list{padding:2px 0 5px;border-top:1px solid var(--border);}
.task-row{
  display:flex;align-items:flex-start;gap:8px;padding:8px 13px;
  transition:background 0.1s;cursor:pointer;
  border-bottom:1px solid rgba(140,100,50,0.2);
}
.task-row:last-child{border-bottom:none;}
.task-row:active{background:rgba(255,215,0,0.04);}
.task-row.done{opacity:0.35;}
.status-icon{font-size:16px;flex-shrink:0;padding-top:1px;cursor:pointer;transition:transform 0.1s;line-height:1;}
.status-icon:active{transform:scale(1.3);}
.priority-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;margin-top:6px;}
.task-body{flex:1;min-width:0;}
.task-title{font-size:15px;color:var(--text);line-height:1.5;word-break:break-word;letter-spacing:0.3px;}
.task-title.done{text-decoration:line-through;color:var(--text3);}
.task-meta{display:flex;gap:4px;margin-top:3px;flex-wrap:wrap;align-items:center;}
.status-pill{font-size:10px;padding:2px 7px;border-radius:2px;white-space:nowrap;font-family:var(--font-hud);letter-spacing:0.5px;}
.due-label{font-size:10px;color:var(--text3);}
.due-label.overdue{color:var(--saber-red);text-shadow:0 0 4px rgba(255,32,32,0.4);}
.empty{padding:10px 13px;font-size:13px;color:var(--text4);font-style:italic;letter-spacing:0.5px;}

/* QUEST EXPAND */
.task-expand{
  margin:0 10px 8px 32px;
  background:rgba(228,210,170,0.97);
  border-radius:3px;padding:10px;
  border:1px solid var(--border2);
  border-left:1px solid var(--gold2);
  animation:slideDown 0.18s ease;
}
@keyframes slideDown{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
.expand-row{display:flex;gap:5px;margin-bottom:7px;flex-wrap:wrap;}
.expand-sel{
  background:rgba(252,240,210,0.95);border:1px solid rgba(140,100,50,0.45);color:var(--text);
  padding:5px 7px;border-radius:2px;font-family:var(--font-hud);font-size:10px;
  letter-spacing:0.5px;outline:none;flex:1;min-width:80px;
}
.expand-sel:focus{border-color:var(--gold);}
.expand-notes{
  background:rgba(252,240,210,0.95);border:1px solid rgba(140,100,50,0.45);color:var(--text);
  padding:7px;border-radius:2px;font-family:var(--font-data);font-size:12px;
  width:100%;resize:none;outline:none;line-height:1.5;
}
.expand-notes:focus{border-color:var(--gold2);}

/* BOTTOM COMMAND NAV */
#bottom-nav{
  background:linear-gradient(0deg,rgba(164,132,88,0.99) 0%,rgba(184,152,104,0.98) 100%);
  border-top:2px solid rgba(90,58,20,0.45);
  display:flex;align-items:stretch;flex-shrink:0;
  padding-bottom:env(safe-area-inset-bottom);
  box-shadow:0 -2px 12px rgba(80,52,24,0.3);
}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:7px 4px;cursor:pointer;border:none;background:transparent;color:var(--text2);
  font-size:8px;font-family:var(--font-hud);font-weight:700;letter-spacing:1px;
  gap:3px;transition:color 0.15s;outline:none;
  -webkit-user-select:none;user-select:none;text-transform:uppercase;
}
.nav-btn .nav-icon{font-size:20px;line-height:1;}
.nav-btn.active{color:var(--gold);text-shadow:0 0 8px rgba(255,140,20,0.7),0 0 16px rgba(212,160,23,0.4);}
.nav-btn:active{opacity:0.7;}

/* MODALS ‚Äî HOLOGRAPHIC DISPLAY */
.modal-overlay{
  position:fixed;inset:0;
  background:rgba(220,200,160,0.97);
  display:flex;align-items:flex-end;justify-content:center;z-index:200;
  animation:fadeIn 0.15s ease;
  backdrop-filter:blur(4px);
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-sheet{
  background:linear-gradient(180deg,rgba(240,220,176,0.99) 0%,rgba(228,204,156,0.99) 100%);
  border:2px solid rgba(120,80,30,0.5);
  border-bottom:none;
  border-radius:6px 6px 0 0;
  width:100%;max-width:600px;
  padding:18px 18px 0;
  padding-bottom:calc(18px + env(safe-area-inset-bottom));
  max-height:88vh;overflow-y:auto;
  animation:slideUp 0.2s ease;
  box-shadow:0 -4px 30px rgba(80,52,24,0.35),inset 0 0 40px rgba(255,235,180,0.3);
}
.modal-sheet::before{
  content:'';display:block;width:50px;height:3px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  margin:0 auto 16px;border-radius:2px;
}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{
  font-family:var(--font-hud);font-size:14px;font-weight:900;
  color:var(--gold);letter-spacing:3px;text-transform:uppercase;margin-bottom:16px;
  text-shadow:0 0 10px rgba(255,215,0,0.3);
}
.field-group{display:flex;flex-direction:column;gap:9px;margin-bottom:14px;}
.field-input{
  background:rgba(252,240,210,0.95);border:1px solid rgba(140,100,50,0.45);color:var(--text);
  padding:10px 12px;border-radius:3px;font-family:var(--font-data);font-size:13px;
  outline:none;width:100%;
}
.field-input:focus{border-color:var(--gold);box-shadow:0 0 6px rgba(120,80,20,0.2);}
.field-input::placeholder{color:var(--text3);}
.field-row{display:flex;gap:7px;}
.field-select{
  background:rgba(252,240,210,0.95);border:1px solid rgba(140,100,50,0.45);color:var(--text);
  padding:10px 10px;border-radius:3px;font-family:var(--font-hud);font-size:11px;
  letter-spacing:0.5px;outline:none;flex:1;
}
.field-select:focus{border-color:var(--gold);}
.field-select option{background:#E8D4A8;color:#2A1A08;}
.modal-actions{display:flex;gap:7px;margin-bottom:14px;}
.modal-btn{
  flex:1;padding:11px;border-radius:3px;border:none;cursor:pointer;
  font-family:var(--font-hud);font-size:12px;font-weight:700;letter-spacing:1.5px;
  transition:all 0.15s;outline:none;text-transform:uppercase;
}
.modal-btn.confirm{
  background:rgba(122,74,16,0.15);border:1px solid var(--gold);color:var(--gold);
}
.modal-btn.confirm:active{background:rgba(255,215,0,0.2);}
.modal-btn.cancel{background:rgba(160,128,80,0.2);border:1px solid rgba(140,100,50,0.5);color:var(--text2);}
.modal-btn.danger{background:rgba(122,24,24,0.10);color:#7A1818;border:1px solid rgba(122,24,24,0.5);}

/* WAR ROOM (focus mode) */
.focus-header{
  font-family:var(--font-hud);font-size:11px;font-weight:900;
  color:var(--gold);letter-spacing:3px;margin-bottom:12px;text-transform:uppercase;
  text-shadow:0 0 8px rgba(255,215,0,0.3);
}

/* BATTLE PLANNER (pomodoro) */
.pomo-card{
  background:linear-gradient(135deg,rgba(220,195,150,0.97) 0%,rgba(208,178,130,0.98) 100%);
  border:1px solid rgba(122,24,24,0.35);
  border-radius:4px;padding:14px;margin-bottom:12px;
  box-shadow:0 0 20px rgba(255,32,32,0.05),inset 0 0 30px rgba(50,0,0,0.3);
}
.pomo-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.pomo-title{font-family:var(--font-hud);font-size:13px;font-weight:900;color:var(--saber-red);letter-spacing:2px;text-shadow:0 0 8px rgba(255,32,32,0.5);}
.pomo-mode-btns{display:flex;gap:4px;}
.pomo-mbtn{
  background:transparent;border:1px solid var(--border2);color:var(--text4);
  padding:3px 7px;border-radius:2px;cursor:pointer;
  font-size:9px;font-family:var(--font-hud);font-weight:700;letter-spacing:1px;outline:none;
}
.pomo-mbtn.active-work{border-color:var(--saber-red);color:var(--saber-red);background:rgba(255,32,32,0.08);text-shadow:0 0 6px rgba(255,32,32,0.4);}
.pomo-mbtn.active-shortBreak{border-color:var(--saber-green);color:var(--saber-green);background:rgba(57,255,20,0.06);}
.pomo-mbtn.active-longBreak{border-color:var(--saber-blue);color:var(--saber-blue);background:rgba(0,191,255,0.06);}
.pomo-body{display:flex;align-items:center;gap:14px;}
.pomo-ring-wrap{position:relative;flex-shrink:0;}
.pomo-time{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.pomo-digits{font-family:var(--font-hud);font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1;}
.pomo-mode-lbl{font-size:9px;letter-spacing:2px;margin-top:3px;font-family:var(--font-hud);font-weight:700;}
.pomo-controls{flex:1;}
.pomo-dots{display:flex;gap:5px;margin-bottom:10px;align-items:center;}
.pomo-dot{width:9px;height:9px;border-radius:50%;background:var(--border);border:1px solid var(--border2);transition:all 0.3s;}
.pomo-dot.filled{background:var(--saber-red);border-color:var(--saber-red);box-shadow:0 0 6px rgba(255,32,32,0.5);}
.pomo-sessions{font-size:11px;color:var(--text4);margin-left:2px;font-family:var(--font-hud);}
.pomo-btns{display:flex;gap:5px;}
.pomo-start{
  border:none;border-radius:3px;cursor:pointer;
  font-family:var(--font-hud);font-size:11px;font-weight:900;letter-spacing:2px;
  padding:8px 14px;min-width:90px;transition:all 0.15s;outline:none;text-transform:uppercase;
}
.pomo-start:active{transform:scale(0.96);}
.pomo-reset{
  background:transparent;border:1px solid var(--border2);color:var(--text4);
  padding:8px 10px;border-radius:3px;cursor:pointer;font-size:13px;outline:none;
}
.pomo-next{font-size:9px;color:var(--text4);margin-top:7px;font-family:var(--font-hud);letter-spacing:0.5px;}

/* HIGH VALUE TARGETS (priority tasks in focus) */
.focus-tasks-card{
  background:linear-gradient(135deg,rgba(5,10,5,0.97) 0%,rgba(3,8,3,0.99) 100%);
  border:1px solid rgba(57,255,20,0.2);border-radius:4px;padding:14px;
  box-shadow:0 0 20px rgba(57,255,20,0.03),inset 0 0 30px rgba(0,30,0,0.3);
}
.focus-task-row{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.focus-task-row:last-child{border-bottom:none;}

/* REALM MAP (calendar) */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-nav-btn{
  background:rgba(255,215,0,0.06);border:1px solid var(--gold2);color:var(--gold);
  padding:6px 14px;border-radius:3px;cursor:pointer;font-size:14px;outline:none;
  font-family:var(--font-hud);
}
.cal-month{font-family:var(--font-hud);font-size:14px;font-weight:900;color:var(--gold);letter-spacing:2px;text-shadow:0 0 10px rgba(255,215,0,0.3);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:12px;}
.cal-day-hdr{text-align:center;font-size:8px;color:var(--text4);padding:2px 0;letter-spacing:1px;font-family:var(--font-hud);}
.cal-cell{
  background:rgba(208,188,148,0.98);border:1px solid rgba(140,100,50,0.3);
  border-radius:2px;min-height:52px;padding:3px;cursor:default;
  transition:border-color 0.15s;
}
.cal-cell.has-tasks{cursor:pointer;background:rgba(210,185,140,0.9);}
.cal-cell.today{border-color:var(--gold);background:rgba(255,215,0,0.05);box-shadow:0 0 8px rgba(255,215,0,0.1);}
.cal-cell.overdue-day{border-color:rgba(255,32,32,0.4);}
.cal-day-num{font-size:9px;text-align:right;margin-bottom:2px;font-family:var(--font-hud);}
.cal-day-num.today{color:var(--gold);font-weight:900;text-shadow:0 0 6px rgba(255,215,0,0.5);}
.cal-day-num.overdue{color:var(--saber-red);}
.cal-day-num.normal{color:var(--text3);}
.cal-chip{border-radius:2px;padding:1px 3px;margin-bottom:1px;font-size:7px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cal-more{font-size:7px;color:var(--text4);text-align:center;font-family:var(--font-hud);}
.upcoming-card{
  background:rgba(232,212,172,0.97);border:1px solid rgba(140,100,50,0.35);
  border-left:2px solid var(--gold2);border-radius:3px;padding:12px;
}
.upcoming-title{font-family:var(--font-hud);font-size:9px;font-weight:900;color:var(--gold);letter-spacing:2px;margin-bottom:10px;}
.upcoming-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);cursor:pointer;}
.upcoming-row:last-child{border-bottom:none;}
.due-badge{min-width:46px;text-align:center;padding:3px 0;border-radius:2px;}
.due-badge-lbl{font-size:7px;letter-spacing:1px;font-family:var(--font-hud);font-weight:700;}
.due-badge-date{font-size:10px;font-weight:500;font-family:var(--font-hud);}

/* GUILD HALL (settings) */
.section-title{
  font-family:var(--font-hud);font-size:9px;font-weight:900;
  color:var(--gold);letter-spacing:3px;margin-bottom:8px;text-transform:uppercase;
  text-shadow:0 0 6px rgba(255,215,0,0.2);
}
.import-zone{
  border:1px dashed var(--border2);border-radius:3px;padding:22px;
  text-align:center;cursor:pointer;transition:border-color 0.15s;
}
.import-zone:active{border-color:var(--gold2);}
.preview-summary{display:flex;gap:7px;margin-bottom:10px;}
.preview-stat{flex:1;border-radius:3px;padding:8px;text-align:center;}
.preview-stat-num{font-family:var(--font-hud);font-size:20px;font-weight:900;}
.preview-stat-lbl{font-size:8px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;}
.preview-task-row{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border);font-size:11px;}

/* SWATCH */
.swatch-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:5px;}
.swatch{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color 0.15s;box-shadow:0 0 6px rgba(0,0,0,0.5);}
.swatch.selected{border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,0.3);}

/* CHARTS SCREEN */
.charts-screen{padding:12px;display:flex;flex-direction:column;gap:16px;background:transparent;}
.chart-range-bar{display:flex;gap:4px;margin-bottom:4px;}
.crng{background:transparent;border:1px solid var(--border2);color:var(--text3);padding:5px 10px;border-radius:2px;cursor:pointer;font-size:11px;font-family:var(--font-hud);letter-spacing:1px;transition:all 0.15s;outline:none;}
.crng.active{background:rgba(255,215,0,0.08);border-color:var(--gold2);color:var(--gold);}
.chart-card{background:linear-gradient(135deg,rgba(232,212,172,0.97),rgba(220,198,152,0.98));border:1px solid rgba(140,100,50,0.4);border-radius:4px;padding:12px;overflow:hidden;box-shadow:0 1px 4px rgba(80,52,24,0.15);}
.chart-card-title{font-family:var(--font-hud);font-size:10px;font-weight:900;color:var(--gold);letter-spacing:2px;margin-bottom:10px;text-shadow:0 0 6px rgba(255,215,0,0.2);}
.chart-stat-row{display:flex;gap:8px;flex-wrap:wrap;}
.chart-stat{flex:1;min-width:60px;background:rgba(255,242,210,0.7);border:1px solid rgba(140,100,50,0.35);border-radius:3px;padding:8px;text-align:center;}
.chart-stat-num{font-family:var(--font-hud);font-size:22px;font-weight:900;line-height:1;}
.chart-stat-lbl{font-size:9px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;margin-top:2px;}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.bar-label{font-size:10px;color:var(--text2);font-family:var(--font-hud);width:80px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:0.5px;}
.bar-track{flex:1;height:14px;background:rgba(255,255,255,0.04);border-radius:2px;overflow:hidden;position:relative;}
.bar-fill{height:100%;border-radius:2px;transition:width 0.4s;}
.bar-count{font-size:10px;color:var(--text3);font-family:var(--font-hud);min-width:24px;text-align:right;flex-shrink:0;}
.donut-wrap{display:flex;align-items:center;gap:16px;}
.donut-legend{display:flex;flex-direction:column;gap:5px;flex:1;}
.donut-legend-item{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text2);font-family:var(--font-hud);}
.donut-legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.sparkline-wrap{overflow-x:auto;padding-bottom:4px;}

/* DRAG AND DROP */
.project-card{transition:opacity 0.15s,transform 0.15s;}
.project-card.dragging{opacity:0.35;transform:scale(0.98);}
.project-card.drag-over{border-top:2px solid var(--gold);margin-top:-1px;}
.drag-handle{
  cursor:grab;color:var(--text4);font-size:16px;padding:0 4px 0 0;
  flex-shrink:0;touch-action:none;user-select:none;line-height:1;
}
.drag-handle:active{cursor:grabbing;color:var(--gold2);}

/* DIFFICULTY CHIPS */
.effort-chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px;}
.effort-chip{background:transparent;border:1px solid var(--border2);color:var(--text3);padding:5px 10px;border-radius:2px;cursor:pointer;font-size:11px;font-family:var(--font-hud);letter-spacing:0.5px;transition:all 0.15s;outline:none;display:flex;flex-direction:column;align-items:center;gap:1px;min-width:60px;}
.effort-chip .ec-icon{font-size:13px;letter-spacing:-1px;}
.effort-chip .ec-lbl{font-size:8px;letter-spacing:1px;}
.effort-chip.active-peasant{background:rgba(139,154,106,0.1);border-color:#8B9A6A;color:#8B9A6A;}
.effort-chip.active-squire{background:rgba(74,144,217,0.1);border-color:#4A90D9;color:#4A90D9;}
.effort-chip.active-knight{background:rgba(212,160,23,0.1);border-color:#D4A017;color:#D4A017;}
.effort-chip.active-champion{background:rgba(139,32,32,0.1);border-color:#8B2020;color:#8B2020;}
.effort-badge{display:inline-flex;align-items:center;gap:2px;font-size:9px;padding:1px 6px;border-radius:2px;font-family:var(--font-hud);letter-spacing:0.5px;white-space:nowrap;border:1px solid;}

/* RECURRENCE CHIPS */
.recur-chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px;}
.recur-chip{background:transparent;border:1px solid var(--border2);color:var(--text3);padding:4px 10px;border-radius:2px;cursor:pointer;font-size:11px;font-family:var(--font-hud);letter-spacing:0.5px;transition:all 0.15s;outline:none;}
.recur-chip.active{background:rgba(191,0,255,0.12);border-color:#BF00FF;color:#BF00FF;text-shadow:0 0 6px rgba(191,0,255,0.4);}
.recur-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;padding:1px 6px;border-radius:2px;border:1px solid rgba(191,0,255,0.4);background:rgba(191,0,255,0.1);color:#BF00FF;font-family:var(--font-hud);letter-spacing:0.5px;white-space:nowrap;}

/* RICH NOTES EDITOR */
.notes-toolbar{display:flex;gap:3px;padding:5px 7px;background:rgba(200,170,110,0.95);border:1px solid rgba(140,100,50,0.4);border-bottom:none;border-radius:3px 3px 0 0;flex-wrap:wrap;}
.ntb{background:transparent;border:1px solid var(--border2);color:var(--text2);padding:3px 8px;border-radius:2px;cursor:pointer;font-size:12px;font-family:var(--font-data);transition:all 0.15s;outline:none;line-height:1.2;}
.ntb:active,.ntb.active{background:rgba(255,215,0,0.12);border-color:var(--gold2);color:var(--gold);}
.ntb-sep{width:1px;background:var(--border2);margin:2px 3px;flex-shrink:0;}
.notes-editor{background:rgba(255,245,220,0.9);border:1px solid rgba(140,100,50,0.4);color:var(--text);padding:10px 12px;border-radius:0 0 3px 3px;font-family:var(--font-data);font-size:16px;min-height:80px;outline:none;line-height:1.6;word-break:break-word;}
.notes-editor:focus{border-color:var(--gold2);box-shadow:0 0 8px rgba(255,215,0,0.08);}
.notes-editor:empty:before{content:attr(data-placeholder);color:var(--text3);pointer-events:none;}
.notes-editor ul{padding-left:18px;margin:4px 0;}
.notes-editor li{margin:2px 0;}
.notes-editor b,.notes-editor strong{color:#fff;}
.notes-editor i,.notes-editor em{color:var(--text2);}
.notes-editor u{text-decoration-color:var(--gold2);}
.notes-editor .task-check{display:flex;align-items:flex-start;gap:7px;margin:3px 0;}
.notes-editor .task-check input[type=checkbox]{accent-color:var(--gold);width:15px;height:15px;flex-shrink:0;margin-top:3px;cursor:pointer;}
.notes-editor .task-check span.checked{text-decoration:line-through;color:var(--text3);}
.notes-rendered{font-size:13px;color:var(--text3);margin-top:4px;line-height:1.6;word-break:break-word;}
.notes-rendered ul{padding-left:16px;margin:2px 0;}
.notes-rendered li{margin:1px 0;}
.notes-rendered b,.notes-rendered strong{color:var(--text2);}
.notes-rendered .task-check{display:flex;align-items:flex-start;gap:6px;margin:2px 0;}
.notes-rendered .task-check input[type=checkbox]{accent-color:var(--gold);width:13px;height:13px;flex-shrink:0;margin-top:2px;}
.notes-rendered .task-check span.checked{text-decoration:line-through;color:var(--text3);}

/* TOAST */
#toast{
  position:fixed;bottom:75px;left:50%;transform:translateX(-50%) translateY(20px);
  background:rgba(224,204,164,0.97);
  border:1px solid var(--gold2);
  color:var(--gold);
  padding:7px 18px;border-radius:3px;font-size:11px;z-index:300;
  opacity:0;transition:all 0.25s;pointer-events:none;white-space:nowrap;
  font-family:var(--font-hud);letter-spacing:1px;
  text-shadow:0 0 6px rgba(255,215,0,0.3);
  box-shadow:0 0 20px rgba(255,215,0,0.1);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* LOADING SCREEN ‚Äî OPENING CRAWL STYLE */
#loading{
  position:fixed;inset:0;background:#C8B89A;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:400;gap:16px;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 47px,rgba(80,52,24,0.15) 47px,rgba(80,52,24,0.15) 49px),repeating-linear-gradient(90deg,transparent,transparent 59px,rgba(80,52,24,0.10) 59px,rgba(80,52,24,0.10) 61px),radial-gradient(ellipse at 50% 0%,rgba(255,220,120,0.35) 0%,transparent 60%);
}
#loading-logo{
  font-family:var(--font-hud);font-size:28px;font-weight:900;
  color:var(--gold);letter-spacing:6px;text-align:center;
  text-shadow:0 0 20px rgba(255,215,0,0.5),0 0 40px rgba(255,215,0,0.2);
  animation:logoGlow 2s ease-in-out infinite alternate;
}
#loading-sub{font-family:var(--font-hud);font-size:9px;color:var(--gold2);letter-spacing:4px;margin-top:-8px;}
#loading-msg{font-family:var(--font-hud);font-size:12px;color:var(--text3);letter-spacing:2px;}
.loading-spinner{
  width:36px;height:36px;
  border:2px solid var(--border2);
  border-top-color:var(--gold);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes logoGlow{from{text-shadow:0 0 20px rgba(255,215,0,0.3)}to{text-shadow:0 0 30px rgba(255,215,0,0.7),0 0 60px rgba(255,215,0,0.2)}}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="gate" style="position:fixed;inset:0;background:#C0A878;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;gap:20px;background-image:repeating-linear-gradient(0deg,transparent,transparent 47px,rgba(80,52,24,0.15) 47px,rgba(80,52,24,0.15) 49px),repeating-linear-gradient(90deg,transparent,transparent 59px,rgba(80,52,24,0.10) 59px,rgba(80,52,24,0.10) 61px),radial-gradient(ellipse at 50% 0%,rgba(255,220,120,0.4) 0%,transparent 60%);">
  <div style="font-family:'Cinzel',serif;font-size:26px;font-weight:900;color:var(--gold);letter-spacing:4px;text-align:center;text-shadow:1px 2px 0 rgba(255,230,160,0.8),0 0 20px rgba(122,74,16,0.3);">‚öî QUEST BOARD ‚öî</div>
  <div style="font-family:'Cinzel',serif;font-size:9px;color:var(--text3);letter-spacing:4px;">GUILD HEADQUARTERS</div>
  <div style="font-family:'Cinzel',serif;font-size:10px;color:var(--text3);letter-spacing:2px;margin-top:4px;">SPEAK FRIEND AND ENTER</div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;max-width:280px;">
    <input id="gate-input" type="password" placeholder="SPEAK THE PASSWORD‚Ä¶"
      style="background:rgba(252,240,210,0.95);border:2px solid rgba(140,100,50,0.6);color:var(--text);padding:12px 16px;border-radius:3px;font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;outline:none;width:100%;text-align:center;"
      onkeydown="if(event.key==='Enter')checkPassword()"/>
    <button onclick="checkPassword()"
      style="background:rgba(122,74,16,0.2);border:2px solid rgba(122,74,16,0.7);color:var(--text);padding:10px 28px;border-radius:3px;font-family:'Cinzel',serif;font-size:11px;font-weight:900;letter-spacing:3px;cursor:pointer;width:100%;">
      ‚ñ∂ ENTER
    </button>
    <div id="gate-error" style="font-family:'Cinzel',serif;font-size:9px;color:#7A1818;letter-spacing:2px;display:none;text-shadow:0 0 6px rgba(255,32,32,0.4);">‚ö† THE PASSWORD IS WRONG</div>
  </div>
  <div style="font-family:'Cinzel',serif;font-size:8px;color:var(--text3);letter-spacing:2px;margin-top:20px;">ACCESS EXPIRES AFTER 60 MINUTES</div>
</div>
<div id="loading">
  <div id="loading-logo">‚öî QUEST BOARD ‚öî</div>
  <div id="loading-sub">GUILD HEADQUARTERS</div>
  <div class="loading-spinner"></div>
  <div id="loading-msg">CONSULTING THE GUILD ARCHIVES‚Ä¶</div>
</div>

<div id="app" style="display:none;">

<!-- DUNGEON ATMOSPHERE -->
<div id="dungeon-bg">
  <div class="torch torch-tl"></div>
  <div class="torch torch-tr"></div>
  <div class="torch torch-bl"></div>
  <div class="torch torch-br"></div>
  <div class="rune rune-1"></div>
  <div class="rune rune-2"></div>
  <div class="rune rune-3"></div>
  <div class="cracks"></div>
  <div class="midglow"></div>
  <div class="vignette"></div>
</div>

  <!-- HEADER -->
  <div id="header">
    <div id="header-brand">
      <div id="header-title">‚öî QUEST BOARD</div>
      <div id="header-sub">GUILD HEADQUARTERS</div>
      <div id="header-stats" class="stats"></div>
    </div>
    <div id="header-actions">
      <button class="hbtn" id="btn-search" onclick="toggleSearch()">üîç</button>
      <button class="hbtn" id="btn-focus" onclick="toggleFocus()">ADVENTURE</button>
      <button class="hbtn primary" onclick="openAddTask()">+ QUEST</button>
    </div>
  </div>

  <!-- GUILD ARCHIVE SYNC BAR -->
  <div id="sync-bar">
    <div id="sync-dot"></div>
    <div id="sync-label">GUILD ARCHIVES LINKED</div>
    <div style="margin-left:auto;">
      <button class="hbtn" style="padding:2px 8px;font-size:9px;" onclick="syncNow()">‚Üª SYNC</button>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="search-bar">
    <input id="search-input" type="search" placeholder="SEARCH QUEST BOARD‚Ä¶" oninput="renderAll()" autocomplete="off" autocorrect="off" spellcheck="false"/>
  </div>

  <!-- TACTICAL FILTER BAR -->
  <div id="filter-bar">
    <button class="fbtn active-all" id="f-all" onclick="setDomainFilter('all')">ALL</button>
    <button class="fbtn" id="f-work" onclick="setDomainFilter('work')">‚öî KINGDOM</button>
    <button class="fbtn" id="f-personal" onclick="setDomainFilter('personal')">üè° HOMESTEAD</button>
    <div class="filter-sep"></div>
    <button class="fbtn active-status" id="fs-active" onclick="setStatusFilter('active')">ACTIVE</button>
    <button class="fbtn" id="fs-all" onclick="setStatusFilter('all')">ALL</button>
    <button class="fbtn" id="fs-done" onclick="setStatusFilter('done')">COMPLETE</button>
    <div class="filter-sep"></div>
    <button class="fbtn active-view" id="fv-list" onclick="setView('list')">‚â° LOG</button>
    <button class="fbtn" id="fv-cal" onclick="setView('calendar')">‚òÖ MAP</button>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main"></div>

  <!-- COMMAND NAV -->
  <div id="bottom-nav">
    <button class="nav-btn active" id="nav-tasks" onclick="setNav('tasks')">
      <span class="nav-icon">‚ò∞</span>QUESTS
    </button>
    <button class="nav-btn" id="nav-focus" onclick="setNav('focus')">
      <span class="nav-icon">üéØ</span>BATTLE STA.
    </button>
    <button class="nav-btn" id="nav-cal" onclick="setNav('cal')">
      <span class="nav-icon">‚òÖ</span>REALM MAP
    </button>
    <button class="nav-btn" id="nav-add" onclick="openAddTask()">
      <span class="nav-icon" style="color:var(--gold);font-size:26px;line-height:1;">‚äï</span>
      <span style="color:var(--gold);">NEW</span>
    </button>
    <button class="nav-btn" id="nav-charts" onclick="setNav('charts')">
      <span class="nav-icon">üìä</span>INTEL
    </button>
    <button class="nav-btn" id="nav-settings" onclick="setNav('settings')">
      <span class="nav-icon">‚öô</span>GUILD ARCHIVES
    </button>
  </div>
</div>

<div id="toast"></div>

<!-- ADD/EDIT QUEST MODAL -->
<div id="modal-task" class="modal-overlay" style="display:none;" onclick="closeModal('modal-task')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title" id="modal-task-title">‚äï NEW QUEST</div>
    <div class="field-group">
      <input class="field-input" id="task-title-input" placeholder="DESCRIBE THE QUEST‚Ä¶" autocomplete="off"/>
      <select class="field-select" id="task-project-input">
        <option value="">SELECT PARTY‚Ä¶</option>
      </select>
      <div class="field-row">
        <select class="field-select" id="task-priority-input">
          <option value="high">üêâ DRAGON</option>
          <option value="medium" selected>üëπ ORC</option>
          <option value="low">üë∫ GOBLIN</option>
        </select>
        <select class="field-select" id="task-status-input">
          <option value="todo">‚óã PENDING</option>
          <option value="inprogress">‚óë ADVENTURED</option>
          <option value="blocked">‚äò BLOCKED</option>
          <option value="done">‚óè COMPLETE</option>
        </select>
      </div>
      <input class="field-input" id="task-due-input" type="date" style="color-scheme:dark;color:var(--gold);font-family:var(--font-hud);letter-spacing:1px;"/>
      <div>
        <div class="notes-toolbar" id="notes-toolbar">
          <button class="ntb" onmousedown="event.preventDefault();noteCmd('bold')"><b>B</b></button>
          <button class="ntb" onmousedown="event.preventDefault();noteCmd('italic')"><i>I</i></button>
          <button class="ntb" onmousedown="event.preventDefault();noteCmd('underline')"><u>U</u></button>
          <div class="ntb-sep"></div>
          <button class="ntb" onmousedown="event.preventDefault();noteCmd('insertUnorderedList')">‚Ä¢ LIST</button>
          <button class="ntb" onmousedown="event.preventDefault();insertCheckbox()">‚òë CHECK</button>
          <div class="ntb-sep"></div>
          <button class="ntb" onmousedown="event.preventDefault();noteCmd('removeFormat')" style="font-size:10px;">‚úï CLEAR</button>
        </div>
        <div class="notes-editor" id="task-notes-input" contenteditable="true" data-placeholder="LORE, CONTEXT, OBSTACLES‚Ä¶" spellcheck="false"></div>
      </div>
      <div>
        <div style="font-size:9px;color:var(--text3);margin-bottom:5px;font-family:var(--font-hud);letter-spacing:1px;">üìú QUEST GIVER</div>
        <div id="source-chips" style="display:flex;flex-wrap:wrap;gap:5px;"></div>
      </div>
      <div>
        <div style="font-size:9px;color:var(--text3);margin-bottom:5px;font-family:var(--font-hud);letter-spacing:1px;">üîÅ RECURRING QUEST</div>
        <div class="recur-chips" id="recur-chips"></div>
      </div>
      <div>
        <div style="font-size:9px;color:var(--text3);margin-bottom:5px;font-family:var(--font-hud);letter-spacing:1px;">‚öî QUEST DIFFICULTY</div>
        <div class="effort-chips" id="effort-chips"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn confirm" id="task-save-btn" onclick="saveTask()">INSCRIBE</button>
      <button class="modal-btn cancel" onclick="closeModal('modal-task')">RETREAT</button>
    </div>
    <div id="task-delete-wrap" style="display:none;margin-bottom:16px;">
      <button class="modal-btn danger" style="width:100%;" onclick="deleteCurrentTask()">‚ò† ABANDON QUEST</button>
    </div>
  </div>
</div>

<!-- ADD PARTY MODAL -->
<div id="modal-project" class="modal-overlay" style="display:none;" onclick="closeModal('modal-project')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">‚äï NEW PARTY</div>
    <div class="field-group">
      <input class="field-input" id="proj-name-input" placeholder="PARTY NAME‚Ä¶" autocomplete="off" style="font-family:var(--font-hud);letter-spacing:1px;color:var(--gold);"/>
      <select class="field-select" id="proj-domain-input">
        <option value="work">‚öî KINGDOM (Work)</option>
        <option value="personal">üè° HOMESTEAD</option>
      </select>
      <div>
        <div style="font-size:9px;color:var(--text3);margin-bottom:7px;font-family:var(--font-hud);letter-spacing:1px;">PARTY BANNER COLOR</div>
        <div class="swatch-row" id="proj-color-swatches"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="saveProject()">CHARTER</button>
      <button class="modal-btn cancel" onclick="closeModal('modal-project')">RETREAT</button>
    </div>
  </div>
</div>

<!-- INTEL IMPORT MODAL -->
<div id="modal-import" class="modal-overlay" style="display:none;" onclick="closeModal('modal-import')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">‚¨Ü INTEL UPLOAD</div>
    <div id="import-body"></div>
  </div>
</div>

<input type="file" id="csv-file-input" accept=".csv,text/csv" style="display:none;" onchange="handleCSV(event)"/>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî GUILD ARCHIVES LINK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_URL = "https://script.google.com/macros/s/AKfycbw6EET5ZIuUTne2Xh6CVDPDwN8gRqo6_NIBx1sxVyeMqY0fxMHiFSs5IHKx4ffr9rQ1lQ/exec";

const SEED_PROJECTS = [
  {id:"p1",name:"GES Integration",domain:"work",color:"#00BFFF",collapsed:"false"},
  {id:"p2",name:"Network Management",domain:"work",color:"#BF00FF",collapsed:"false"},
  {id:"p5",name:"Client Discussions",domain:"work",color:"#FFD700",collapsed:"false"},
  {id:"p3",name:"Home",domain:"personal",color:"#39FF14",collapsed:"false"},
  {id:"p4",name:"Family",domain:"personal",color:"#FF8C00",collapsed:"false"},
];
const SEED_TASKS = [
  {id:"t1",projectId:"p1",title:"Review payer system specs",priority:"high",status:"inprogress",notes:"",dueDate:"",createdAt:"1708000000000"},
  {id:"t2",projectId:"p3",title:"Board and batten materials list",priority:"medium",status:"todo",notes:"",dueDate:"",createdAt:"1708000000001"},
  {id:"gt1",projectId:"p1",title:"First draft of board slides",priority:"high",status:"todo",notes:"",dueDate:"2026-02-16",createdAt:"1708000000002"},
  {id:"gt2",projectId:"p1",title:"Exclusion comments disappearing when providers targeted",priority:"high",status:"todo",notes:"",dueDate:"",createdAt:"1708000000003"},
  {id:"gt3",projectId:"p1",title:"Send Humana Notes",priority:"medium",status:"todo",notes:"",dueDate:"2026-02-11",createdAt:"1708000000004"},
  {id:"cd1",projectId:"p5",title:"Enhancement Request 159853 ‚Äì QES Adequacy: Volume Term/Target Report Page Data Addition",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000005"},
  {id:"cd2",projectId:"p5",title:"HCSC ‚Äì Request/Enhancement",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000006"},
  {id:"cd3",projectId:"p5",title:"Enhancement Request 177901 ‚Äì QES Adequacy: CMS Exception Request Form Updates ‚Äì URGENT",priority:"high",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000007"},
  {id:"cd4",projectId:"p5",title:"Enhancement Request 179686 ‚Äì Can Exception/Review Statuses be customizable?",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000008"},
  {id:"cd5",projectId:"p5",title:"Enhancement Request 180310 ‚Äì QES Adequacy: New County Status or Service Area Flag",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000009"},
  {id:"cd6",projectId:"p5",title:"Enhancement Request 180765 ‚Äì Have ECD as the landing page when logging into QES",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000010"},
  {id:"cd7",projectId:"p5",title:"Look at Humana enhancement item",priority:"medium",status:"todo",notes:"",dueDate:"",createdAt:"1708000000011"},
  {id:"cd8",projectId:"p5",title:"Review and discuss United enhancement items",priority:"medium",status:"todo",notes:"",dueDate:"",createdAt:"1708000000012"},
  {id:"cd9",projectId:"p5",title:"Send Melissa action items from Humana",priority:"high",status:"todo",notes:"Note",dueDate:"",createdAt:"1708000000013"},
  {id:"cd10",projectId:"p5",title:"EXTERNAL ‚Äì VRC starting information",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000014"},
  {id:"cd11",projectId:"p5",title:"Volume Terminations Enhancement Request",priority:"medium",status:"todo",notes:"Message",dueDate:"",createdAt:"1708000000015"},
  {id:"cd12",projectId:"p5",title:"Scenario modeling ‚Äì volume reporting on projected timeslice",priority:"medium",status:"todo",notes:"",dueDate:"",createdAt:"1708000000016"},
];

// Star Wars themed labels
const PRIORITY_COLOR = {high:"#8B2020",medium:"#D4A017",low:"#5C5C40"};
const PRIORITY_LABEL = {high:"CRITICAL",medium:"STANDARD",low:"LOW"};
const STATUS_ICON    = {todo:"‚óã",inprogress:"‚öî",blocked:"üíÄ",done:"‚úì"};
const STATUS_LABEL   = {todo:"OPEN",inprogress:"ACTIVE",blocked:"CURSED",done:"COMPLETE"};
const STATUS_COLOR   = {todo:"#7A6040",inprogress:"#D4A017",blocked:"#8B2020",done:"#5C8A3C"};
const PROJECT_COLORS = ["#00BFFF","#BF00FF","#FFD700","#39FF14","#FF8C00","#FF2020","#00FFFF","#FF69B4"];

const SOURCE_OPTIONS = [
  {val:'personal-email', label:'PERSONAL MAIL',  icon:'üì©', color:'#39FF14'},
  {val:'work-email',     label:'IMPERIAL COMM',  icon:'üì®', color:'#00BFFF'},
  {val:'slack',          label:'GUILD CHAT',  icon:'üí¨', color:'#BF00FF'},
  {val:'ridley',         label:'RIDLEY',         icon:'‚ö°',    color:'#FFD700'},
  {val:'jenny',          label:'JENNY',          icon:'‚ö°',    color:'#FF69B4'},
  {val:'connor',         label:'CONNOR',         icon:'‚ö°',    color:'#FF8C00'},
  {val:'other',          label:'UNKNOWN SOURCE', icon:'‚ùì',    color:'#888899'},
];
const DIFFICULTY_LEVELS = [
  {val:"peasant",  label:"PEASANT",  icon:"üåæ", color:"#8B9A6A", desc:"Quick task ‚Äî minutes"},
  {val:"squire",   label:"SQUIRE",   icon:"üõ°", color:"#4A90D9", desc:"Small effort ‚Äî an hour or two"},
  {val:"knight",   label:"KNIGHT",   icon:"‚öî", color:"#D4A017", desc:"Significant effort ‚Äî half day+"},
  {val:"champion", label:"CHAMPION", icon:"üëë", color:"#8B2020", desc:"Major undertaking ‚Äî days"},
];
function effortLabel(val){ const e=DIFFICULTY_LEVELS.find(x=>x.val===val); return e?e.icon+' '+e.label:''; }
function effortColor(val){ const e=DIFFICULTY_LEVELS.find(x=>x.val===val); return e?e.color:'#555580'; }

function sourceLabel(val){ const s=SOURCE_OPTIONS.find(x=>x.val===val); return s?s.icon+' '+s.label:''; }
function sourceColor(val){ const s=SOURCE_OPTIONS.find(x=>x.val===val); return s?s.color:'#888899'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let projects=[], tasks=[];
let domainFilter="all", statusFilter="active", viewMode="list", activeNav="tasks";
let focusOn=false, expandedTaskId=null, editingTaskId=null, selectedMissionId=null;
let dragSrcId=null;
let calendarDate=new Date(), syncTimeout=null;
let selectedProjColor=PROJECT_COLORS[0], importPreviewData=null;

const genId=()=>Math.random().toString(36).substr(2,9);
const today=()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUILD ARCHIVES API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSyncStatus(state,msg){
  const dot=document.getElementById("sync-dot");
  const lbl=document.getElementById("sync-label");
  dot.className=state==="syncing"?"syncing":state==="error"?"error":state==="offline"?"offline":"";
  lbl.textContent=msg;
}

async function apiCall(action,data={}){
  setSyncStatus("syncing","SENDING RAVEN‚Ä¶");
  try{
    const res=await fetch(`${API_URL}?action=${action}`,{method:"POST",body:JSON.stringify({action,...data})});
    const json=await res.json();
    if(json.error) throw new Error(json.error);
    setSyncStatus("ok","GUILD ARCHIVES LINKED ¬∑ "+new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}));
    return json;
  }catch(e){
    const offline=!navigator.onLine;
    setSyncStatus(offline?"offline":"error",offline?"SIGNAL LOST":"RAVEN LOST ‚Äî TAP ‚Üª");
    throw e;
  }
}

async function loadAll(){
  try{
    const data=await apiCall("getAll");
    const sheetProjects=(data.projects||[]).map(p=>({
      ...p,collapsed:p.collapsed==="true"||p.collapsed===true
    })).filter(p=>p.id&&p.name);
    const sheetTasks=(data.tasks||[]).map(t=>({...t})).filter(t=>t.id&&t.title);

    if(sheetProjects.length===0&&sheetTasks.length===0){
      const lp=localStorage.getItem("hub-projects");
      const lt=localStorage.getItem("hub-tasks");
      const localProjects=lp?JSON.parse(lp):[];
      const localTasks=lt?JSON.parse(lt):[];
      if(localProjects.length>0||localTasks.length>0){
        projects=localProjects;tasks=localTasks;
        showToast("GUILD ARCHIVES EMPTY ‚Äî UPLOADING LOCAL TOMES‚Ä¶");
        await apiCall("saveAll",{projects,tasks});
        showToast("‚úì "+projects.length+" PARTIES + "+tasks.length+" QUESTS SENT");
      }else{
        projects=SEED_PROJECTS;tasks=SEED_TASKS;
        showToast("FIRST VISIT ‚Äî UPLOADING TO GUILD ARCHIVES‚Ä¶");
        await apiCall("saveAll",{projects,tasks});
        showToast("‚úì ALL QUESTS SENT TO GUILD ARCHIVES");
      }
    }else{
      projects=sheetProjects;tasks=sheetTasks;
    }
  }catch(e){
    const lp=localStorage.getItem("hub-projects");
    const lt=localStorage.getItem("hub-tasks");
    if(lp) try{projects=JSON.parse(lp);}catch(e2){}
    if(lt) try{tasks=JSON.parse(lt);}catch(e2){}
    showToast("SIGNAL LOST ‚Äî USING LOCAL TOMES");
  }
  if(projects.length>0) localStorage.setItem("hub-projects",JSON.stringify(projects));
  if(tasks.length>0) localStorage.setItem("hub-tasks",JSON.stringify(tasks));
}

async function saveAllDebounced(){
  localStorage.setItem("hub-projects",JSON.stringify(projects));
  localStorage.setItem("hub-tasks",JSON.stringify(tasks));
  clearTimeout(syncTimeout);
  syncTimeout=setTimeout(async()=>{try{await apiCall("saveAll",{projects,tasks});}catch(e){}},800);
}

async function syncNow(){showToast("CONSULTING GUILD ARCHIVES‚Ä¶");await loadAll();renderAll();showToast("GUILD ARCHIVES SYNCED ‚úì");}

async function runDiagnostic(){
  showToast("RUNNING DIVINE ARCHIVES‚Ä¶");
  const lp=localStorage.getItem("hub-projects");
  const lt=localStorage.getItem("hub-tasks");
  const localP=lp?JSON.parse(lp):[];
  const localT=lt?JSON.parse(lt):[];
  let sheetP=0,sheetT=0,sheetErr="";
  try{
    const data=await apiCall("getAll");
    sheetP=(data.projects||[]).filter(p=>p.id&&p.name).length;
    sheetT=(data.tasks||[]).filter(t=>t.id&&t.title).length;
  }catch(e){sheetErr=" (CANNOT REACH GUILD ARCHIVES)";}
  const msg=[
    "=== DIVINATION REPORT ===",
    "LOCAL TOMES:",
    "  Parties: "+localP.length,
    "  Quests: "+localT.length,
    "",
    "GUILD SCROLL"+sheetErr+":",
    "  Parties: "+sheetP,
    "  Quests: "+sheetT,
    "",
    "IN MEMORY:",
    "  Parties: "+projects.length,
    "  Quests: "+tasks.length,
  ].join("\n");
  alert(msg);
}

async function forcePushToSheets(){
  if(!confirm("OVERWRITE GUILD ARCHIVES with local tomes?")) return;
  showToast("UPLOADING ALL DATA‚Ä¶");
  try{await apiCall("saveAll",{projects,tasks});showToast(`‚úì ${projects.length} PARTIES + ${tasks.length} QUESTS SENT`);}
  catch(e){showToast("TRANSQUEST FAILED ‚Äî CHECK SIGNAL");}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  updateStats();
  const main=document.getElementById("main");
  if(activeNav==="focus"||focusOn){renderFocusPanel(main);return;}
  if(activeNav==="cal"||viewMode==="calendar"){renderCalendar(main);return;}
  if(activeNav==="settings"){renderSettings(main);return;}
  if(activeNav==="charts"){renderCharts(main);return;}
  renderTaskList(main);
}

function updateStats(){
  // Keep a simple total count in the header
  const active=tasks.filter(t=>t.status!=="done").length;
  const done=tasks.filter(t=>t.status==="done").length;
  document.getElementById("header-stats").textContent=`${tasks.length} TOTAL ¬∑ ${active} ACTIVE ¬∑ ${done} COMPLETE`;
}

// ‚îÄ‚îÄ METRICS PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildMetrics(taskArr){
  const todayStr=today();
  const weekMs=7*24*60*60*1000;
  const weekDate=new Date(Date.now()+weekMs);
  const weekStr=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,"0")}-${String(weekDate.getDate()).padStart(2,"0")}`;

  // Status counts
  const pending=taskArr.filter(t=>t.status==="todo").length;
  const engaged=taskArr.filter(t=>t.status==="inprogress").length;
  const blocked=taskArr.filter(t=>t.status==="blocked").length;
  const done=taskArr.filter(t=>t.status==="done").length;

  // Due this week (not done, due date exists and <= 7 days from now, >= today)
  const dueWeek=taskArr.filter(t=>t.status!=="done"&&t.dueDate&&t.dueDate>=todayStr&&t.dueDate<=weekStr).length;
  const overdue=taskArr.filter(t=>t.status!=="done"&&t.dueDate&&t.dueDate<todayStr).length;

  // Priority
  const high=taskArr.filter(t=>t.priority==="high"&&t.status!=="done").length;
  const medium=taskArr.filter(t=>t.priority==="medium"&&t.status!=="done").length;
  const low=taskArr.filter(t=>t.priority==="low"&&t.status!=="done").length;

  // Intel source (active tasks only)
  const activeTasks=taskArr.filter(t=>t.status!=="done");
  const srcCounts={};
  activeTasks.forEach(t=>{
    const k=t.source||"none";
    srcCounts[k]=(srcCounts[k]||0)+1;
  });

  if(taskArr.length===0) return "";

  const pill=(label,val,color,bg)=>val>0
    ?`<span style="display:inline-flex;align-items:center;gap:3px;background:${bg};border:1px solid ${color}44;color:${color};font-family:var(--font-hud);font-size:10px;padding:2px 7px;border-radius:2px;white-space:nowrap;"><span style="font-weight:900;">${val}</span> ${label}</span>`
    :"";

  const srcPills=SOURCE_OPTIONS
    .filter(s=>srcCounts[s.val]>0)
    .map(s=>pill(s.icon+" "+s.label, srcCounts[s.val], s.color, s.color+"12"))
    .join("");

  const noSource=srcCounts["none"]>0
    ?pill("NO SOURCE",srcCounts["none"],"#555580","rgba(85,85,128,0.1)")
    :"";

  return `<div style="background:rgba(232,212,172,0.6);border-top:1px solid rgba(140,100,50,0.25);padding:8px 13px;display:flex;flex-direction:column;gap:6px;">
    <!-- Row 1: Status + Due -->
    <div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;">
      <span style="font-size:9px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;flex-shrink:0;margin-right:2px;">STATUS</span>
      ${pill("PENDING",pending,"#555580","rgba(85,85,128,0.15)")}
      ${pill("ADVENTURED",engaged,"#FFD700","rgba(255,215,0,0.08)")}
      ${pill("BLOCKED",blocked,"#FF2020","rgba(255,32,32,0.1)")}
      ${pill("COMPLETE",done,"#39FF14","rgba(57,255,20,0.08)")}
      ${overdue>0?`<span style="display:inline-flex;align-items:center;gap:3px;background:rgba(255,32,32,0.15);border:1px solid rgba(255,32,32,0.5);color:#FF2020;font-family:var(--font-hud);font-size:10px;padding:2px 7px;border-radius:2px;white-space:nowrap;font-weight:900;">‚ö† ${overdue} OVERDUE</span>`:""}
      ${dueWeek>0?`<span style="display:inline-flex;align-items:center;gap:3px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.35);color:#FFD700;font-family:var(--font-hud);font-size:10px;padding:2px 7px;border-radius:2px;white-space:nowrap;">‚è± ${dueWeek} THIS WEEK</span>`:""}
    </div>
    <!-- Row 2: Priority -->
    <div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;">
      <span style="font-size:9px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;flex-shrink:0;margin-right:2px;">PRIORITY</span>
      ${pill("DRAGON",high,"#8B2020","rgba(139,32,32,0.1)")}
      ${pill("ORC",medium,"#D4A017","rgba(212,160,23,0.08)")}
      ${pill("GOBLIN",low,"#5C5C40","rgba(92,92,64,0.1)")}
    </div>
    <!-- Row 3: Intel Source -->
    ${srcPills||noSource?`<div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;">
      <span style="font-size:9px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;flex-shrink:0;margin-right:2px;">SOURCE</span>
      ${srcPills}${noSource}
    </div>`:""}
  </div>`;
}

function getFilteredTasks(projectId){
  const q=(document.getElementById("search-input")?.value||"").toLowerCase();
  let f=tasks.filter(t=>t.projectId===projectId);
  if(statusFilter==="active") f=f.filter(t=>t.status!=="done");
  if(statusFilter==="done") f=f.filter(t=>t.status==="done");
  if(q) f=f.filter(t=>t.title.toLowerCase().includes(q));
  return f.sort((a,b)=>({high:0,medium:1,low:2}[a.priority]||1)-({high:0,medium:1,low:2}[b.priority]||1));
}

function renderTaskList(container){
  const filtered=projects.filter(p=>domainFilter==="all"||p.domain===domainFilter);

  // Build global metrics from all tasks visible under current filters
  const globalTaskPool=tasks.filter(t=>{
    const proj=projects.find(p=>p.id===t.projectId);
    if(!proj) return false;
    if(domainFilter!=="all"&&proj.domain!==domainFilter) return false;
    if(statusFilter==="active"&&t.status==="done") return false;
    if(statusFilter==="done"&&t.status!=="done") return false;
    const q=(document.getElementById("search-input")?.value||"").toLowerCase();
    if(q&&!t.title.toLowerCase().includes(q)) return false;
    return true;
  });
  const globalMetrics=buildMetrics(globalTaskPool);

  let html=globalMetrics
    ?`<div style="background:linear-gradient(135deg,rgba(232,212,172,0.97),rgba(220,198,152,0.98));border:1px solid rgba(140,100,50,0.4);border-radius:4px;margin-bottom:10px;overflow:hidden;box-shadow:0 1px 4px rgba(80,52,24,0.15);">
        <div style="padding:8px 13px 4px;font-family:var(--font-hud);font-size:10px;font-weight:900;color:var(--gold);letter-spacing:2px;text-shadow:0 0 6px rgba(255,215,0,0.2);">‚óà QUEST OVERVIEW</div>
        ${globalMetrics}
      </div>`
    :"";

  for(const proj of filtered){
    const ptasks=getFilteredTasks(proj.id);
    const allPT=tasks.filter(t=>t.projectId===proj.id);
    const done=allPT.filter(t=>t.status==="done").length;
    const pct=allPT.length>0?Math.round(done/allPT.length*100):0;
    const domainStyle=proj.domain==="work"
      ?`background:rgba(0,191,255,0.1);color:#00BFFF;border:1px solid rgba(0,191,255,0.3);`
      :`background:rgba(57,255,20,0.08);color:#39FF14;border:1px solid rgba(57,255,20,0.2);`;

    html+=`<div class="project-card" id="pcard-${proj.id}"
      style="border-left-color:${proj.color||'#FFD700'};"
      draggable="true"
      ondragstart="onProjDragStart(event,'${proj.id}')"
      ondragover="onProjDragOver(event,'${proj.id}')"
      ondragleave="onProjDragLeave(event,'${proj.id}')"
      ondrop="onProjDrop(event,'${proj.id}')"
      ondragend="onProjDragEnd()">
      <div class="project-header" onclick="toggleProject('${proj.id}')">
        <span class="drag-handle" onclick="event.stopPropagation()" title="Drag to reorder">‚†ø</span>
        <div class="project-chevron ${proj.collapsed===true?'closed':'open'}" id="chev-${proj.id}">‚ñº</div>
        <div class="project-info">
          <div class="project-name" style="color:${proj.color||'#FFD700'};text-shadow:0 0 8px ${proj.color||'#FFD700'}44;">‚óà ${esc(proj.name)}</div>
          <div class="project-meta">
            <span class="domain-pill" style="${domainStyle}">${proj.domain==="work"?"KINGDOM":"HOMESTEAD"}</span>
            <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%;background:${proj.color||'#FFD700'};box-shadow:0 0 4px ${proj.color||'#FFD700'}88;"></div></div>
            <span class="progress-count">${done}/${allPT.length}</span>
          </div>
        </div>
        <button class="add-task-btn" style="border-color:${proj.color||'#FFD700'};color:${proj.color||'#FFD700'};"
          onclick="event.stopPropagation();openAddTask('${proj.id}')">+ QUEST</button>
      </div>`;

    // Per-project metrics (all tasks in this project, not filtered by status/search)
    const projAllTasks=tasks.filter(t=>t.projectId===proj.id);
    const projMetrics=buildMetrics(projAllTasks);
    if(projMetrics) html+=projMetrics;

    if(proj.collapsed!==true){
      html+=`<div class="task-list">`;
      if(ptasks.length===0){
        html+=`<div class="empty">${statusFilter==="done"?"‚Äî NO COMPLETED QUESTS ‚Äî":"‚Äî QUEST BOARD CLEAR ‚Äî"}</div>`;
      }
      for(const task of ptasks) html+=renderTaskRow(task,proj);
      html+=`</div>`;
    }
    html+=`</div>`;
  }
  if(filtered.length===0){
    html=`<div style="text-align:center;padding:40px 20px;color:var(--text3);font-size:12px;font-family:var(--font-hud);letter-spacing:1px;">NO PARTIES FOUND<br><br><button class="hbtn" onclick="openAddProject()" style="margin-top:8px;">+ CHARTER PARTY</button></div>`;
  }
  container.innerHTML=html;
}

function renderTaskRow(task,proj){
  const isExpanded=expandedTaskId===task.id;
  const isDone=task.status==="done";
  const todayStr=today();
  const overdue=task.dueDate&&task.dueDate<todayStr&&!isDone;
  const dueStr=task.dueDate?`<span class="due-label ${overdue?'overdue':''}">‚è± ${task.dueDate.slice(5)}</span>`:"";
  const sc=STATUS_COLOR[task.status]||"#555580";
  const sbg={todo:"rgba(50,50,80,0.3)",inprogress:"rgba(255,215,0,0.08)",blocked:"rgba(255,32,32,0.1)",done:"rgba(57,255,20,0.08)"}[task.status]||"rgba(50,50,80,0.3)";
  const statusPill=`<span class="status-pill" style="background:${sbg};color:${sc};border:1px solid ${sc}44;">${STATUS_LABEL[task.status]||task.status}</span>`;

  let expandHtml="";
  if(isExpanded){
    expandHtml=`<div class="task-expand">
      <div class="expand-row">
        <select class="expand-sel" onchange="updateTaskField('${task.id}','priority',this.value)">
          <option value="high" ${task.priority==='high'?'selected':''}>üêâ DRAGON</option>
          <option value="medium" ${task.priority==='medium'?'selected':''}>üëπ ORC</option>
          <option value="low" ${task.priority==='low'?'selected':''}>üë∫ GOBLIN</option>
        </select>
        <select class="expand-sel" onchange="updateTaskField('${task.id}','status',this.value)">
          <option value="todo" ${task.status==='todo'?'selected':''}>‚óã PENDING</option>
          <option value="inprogress" ${task.status==='inprogress'?'selected':''}>‚óë ADVENTURED</option>
          <option value="blocked" ${task.status==='blocked'?'selected':''}>‚äò BLOCKED</option>
          <option value="done" ${task.status==='done'?'selected':''}>‚óè COMPLETE</option>
        </select>
        <input type="date" class="expand-sel" value="${task.dueDate||''}" style="color-scheme:dark;"
          onchange="updateTaskField('${task.id}','dueDate',this.value)"/>
      </div>
      <div class="notes-toolbar" style="border-radius:3px 3px 0 0;">
        <button class="ntb" onmousedown="event.preventDefault();expandNoteCmd('${task.id}','bold')"><b>B</b></button>
        <button class="ntb" onmousedown="event.preventDefault();expandNoteCmd('${task.id}','italic')"><i>I</i></button>
        <button class="ntb" onmousedown="event.preventDefault();expandNoteCmd('${task.id}','underline')"><u>U</u></button>
        <div class="ntb-sep"></div>
        <button class="ntb" onmousedown="event.preventDefault();expandNoteCmd('${task.id}','insertUnorderedList')">‚Ä¢ LIST</button>
        <button class="ntb" onmousedown="event.preventDefault();insertExpandCheckbox('${task.id}')">‚òë CHECK</button>
      </div>
      <div class="notes-editor" id="enotes-${task.id}" contenteditable="true" data-placeholder="QUEST INTEL‚Ä¶"
        onblur="updateTaskField('${task.id}','notes',document.getElementById('enotes-${task.id}').innerHTML)"
        spellcheck="false">${task.notes||''}</div>
      <div style="margin-top:6px;">
        <div style="font-size:8px;color:var(--text3);margin-bottom:4px;font-family:var(--font-hud);letter-spacing:1px;">üìú QUEST GIVER</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;">${SOURCE_OPTIONS.map(s=>`<button onclick="event.stopPropagation();updateTaskSource('${task.id}','${s.val}')" style="padding:3px 8px;border-radius:2px;border:1px solid ${task.source===s.val?s.color:'var(--border2)'};background:${task.source===s.val?s.color+'22':'transparent'};color:${task.source===s.val?s.color:'var(--text3)'};font-size:9px;font-family:var(--font-hud);cursor:pointer;">${s.icon} ${s.label}</button>`).join('')}</div>
      </div>
      <div style="margin-top:6px;">
        <div style="font-size:8px;color:var(--text3);margin-bottom:4px;font-family:var(--font-hud);letter-spacing:1px;">üîÅ RECURRING</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;">${['none','daily','weekly','biweekly','monthly'].map(r=>{const lbl={none:'OFF',daily:'DAILY',weekly:'WEEKLY',biweekly:'BI-WEEKLY',monthly:'MONTHLY'}[r];const active=(task.recur||'none')===r;return `<button onclick="event.stopPropagation();updateTaskField('${task.id}','recur','${r}')" style="padding:3px 8px;border-radius:2px;border:1px solid ${active?'#BF00FF':'var(--border2)'};background:${active?'rgba(191,0,255,0.12)':'transparent'};color:${active?'#BF00FF':'var(--text3)'};font-size:9px;font-family:var(--font-hud);cursor:pointer;letter-spacing:0.5px;">${lbl}</button>`;}).join('')}</div>
      </div>
      <div style="margin-top:6px;">
        <div style="font-size:8px;color:var(--text3);margin-bottom:4px;font-family:var(--font-hud);letter-spacing:1px;">‚öî QUEST DIFFICULTY</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;">${DIFFICULTY_LEVELS.map(e=>{const active=(task.effort||'')===e.val;return `<button onclick="event.stopPropagation();updateTaskField('${task.id}','effort','${e.val}')" style="padding:3px 8px;border-radius:2px;border:1px solid ${active?e.color:'var(--border2)'};background:${active?e.color+'18':'transparent'};color:${active?e.color:'var(--text3)'};font-size:9px;font-family:var(--font-hud);cursor:pointer;letter-spacing:0.5px;">${e.icon} ${e.label}</button>`;}).join('')}</div>
      </div>
      <div style="display:flex;gap:5px;margin-top:7px;">
        <button class="modal-btn confirm" style="font-size:10px;padding:7px;letter-spacing:1px;" onclick="openEditTask('${task.id}')">‚úè EDIT</button>
        <button class="modal-btn danger" style="font-size:10px;padding:7px;flex:none;width:auto;letter-spacing:1px;" onclick="confirmDeleteTask('${task.id}')">‚ò† ABANDON</button>
      </div>
    </div>`;
  }

  return `<div>
    <div class="task-row ${isDone?'done':''}" onclick="toggleExpand('${task.id}')">
      <span class="status-icon" style="color:${sc};text-shadow:0 0 6px ${sc}66;" onclick="event.stopPropagation();cycleStatus('${task.id}')">${STATUS_ICON[task.status]||"‚óã"}</span>
      <span class="priority-dot" style="background:${PRIORITY_COLOR[task.priority]||'#555580'};box-shadow:0 0 4px ${PRIORITY_COLOR[task.priority]||'#555580'};"></span>
      <div class="task-body">
        <div class="task-title ${isDone?'done':''}">${esc(task.title)}</div>
        <div class="task-meta">${statusPill}${dueStr}${task.source?`<span style="font-size:8px;padding:1px 6px;border-radius:2px;border:1px solid ${sourceColor(task.source)}44;background:${sourceColor(task.source)}11;color:${sourceColor(task.source)};font-family:var(--font-hud);">${sourceLabel(task.source)}</span>`:""}${task.recur&&task.recur!=="none"?`<span class="recur-badge">üîÅ ${({daily:"DAILY",weekly:"WEEKLY",biweekly:"BI-WK",monthly:"MONTHLY"})[task.recur]||""}</span>`:""}${task.effort?`<span class="effort-badge" style="color:${effortColor(task.effort)};border-color:${effortColor(task.effort)}44;background:${effortColor(task.effort)}11;">${DIFFICULTY_LEVELS.find(e=>e.val===task.effort)?.icon||""} ${task.effort.toUpperCase()}</span>`:""}</div>
        ${task.notes?`<div class="notes-rendered">${task.notes}</div>`:""}
      </div>
    </div>
    ${expandHtml}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAR ROOM + BATTLE PLANNER (focus + pomodoro)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pomoState={mode:"work",timeLeft:25*60,running:false,sessions:0,customWork:25,interval:null};

function renderFocusPanel(container){
  const todayStr=today();
  const mc=pomoState.mode==="work"?"#FF2020":pomoState.mode==="shortBreak"?"#39FF14":"#00BFFF";
  const ml=pomoState.mode==="work"?"TARGETING":pomoState.mode==="shortBreak"?"RECHARGING":"DEEP REST";
  const totalDur=pomoState.mode==="work"?pomoState.customWork*60:pomoState.mode==="shortBreak"?300:900;
  const pct=1-(pomoState.timeLeft/totalDur);
  const R=44;const circ=2*Math.PI*R;
  const tipAngle=pct*2*Math.PI-Math.PI/2;
  const tipX=52+R*Math.cos(tipAngle);const tipY=52+R*Math.sin(tipAngle);
  const fmt=s=>`${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
  const dots=Array.from({length:4}).map((_,i)=>i<(pomoState.sessions%4));

  // ‚îÄ‚îÄ Selected mission display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sel=selectedMissionId?tasks.find(t=>t.id===selectedMissionId):null;
  const selProj=sel?projects.find(p=>p.id===sel.projectId):null;
  const selHtml=sel
    ?`<div style="background:rgba(255,32,32,0.06);border:1px solid rgba(255,32,32,0.25);border-radius:3px;padding:8px 11px;margin-top:8px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:9px;color:#FF2020;font-family:var(--font-hud);letter-spacing:1px;flex-shrink:0;">üéØ TARGET:</span>
        <div style="flex:1;min-width:0;">
          <div style="font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(sel.title)}</div>
          ${selProj?`<div style="font-size:8px;color:${selProj.color};font-family:var(--font-hud);letter-spacing:1px;margin-top:1px;">‚óà ${esc(selProj.name)}</div>`:""}
        </div>
        <button onclick="selectedMissionId=null;renderAll();" style="background:transparent;border:none;color:var(--text3);font-size:14px;cursor:pointer;flex-shrink:0;padding:0 2px;">‚úï</button>
      </div>`
    :`<div style="margin-top:8px;font-size:9px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;text-align:center;">‚Üì SELECT A QUEST BELOW</div>`;

  // ‚îÄ‚îÄ Today tasks ‚Äî work first then personal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const workProjIds=new Set(projects.filter(p=>p.domain==="work").map(p=>p.id));
  const persProjIds=new Set(projects.filter(p=>p.domain==="personal").map(p=>p.id));

  const isToday=t=>t.dueDate===todayStr&&t.status!=="done";
  const isOverdue=t=>t.dueDate&&t.dueDate<todayStr&&t.status!=="done";
  const todayRelevant=t=>isToday(t)||isOverdue(t);

  const workTasks=tasks.filter(t=>todayRelevant(t)&&workProjIds.has(t.projectId))
    .sort((a,b)=>{
      if(isOverdue(a)&&!isOverdue(b)) return -1;
      if(!isOverdue(a)&&isOverdue(b)) return 1;
      return ({high:0,medium:1,low:2}[a.priority]||1)-({high:0,medium:1,low:2}[b.priority]||1);
    });
  const persTasks=tasks.filter(t=>todayRelevant(t)&&persProjIds.has(t.projectId))
    .sort((a,b)=>{
      if(isOverdue(a)&&!isOverdue(b)) return -1;
      if(!isOverdue(a)&&isOverdue(b)) return 1;
      return ({high:0,medium:1,low:2}[a.priority]||1)-({high:0,medium:1,low:2}[b.priority]||1);
    });

  const totalToday=workTasks.length+persTasks.length;

  function todayTaskRow(t){
    const proj=projects.find(p=>p.id===t.projectId);
    const sc=STATUS_COLOR[t.status]||"#555580";
    const overdue=isOverdue(t);
    const isSel=selectedMissionId===t.id;
    const selStyle=isSel
      ?`background:rgba(255,32,32,0.1);border-color:rgba(255,32,32,0.4);`
      :`background:transparent;border-color:var(--border2);`;
    const srcInfo=t.source?SOURCE_OPTIONS.find(s=>s.val===t.source):null;
    const srcBadge=srcInfo?`<span style="font-size:7px;padding:1px 4px;border-radius:2px;border:1px solid ${srcInfo.color}44;background:${srcInfo.color}11;color:${srcInfo.color};font-family:var(--font-hud);">${srcInfo.icon}</span>`:"";
    return `<div onclick="selectMission('${t.id}')" style="display:flex;align-items:flex-start;gap:8px;padding:8px 10px;border-radius:3px;border:1px solid;margin-bottom:5px;cursor:pointer;transition:all 0.15s;${selStyle}">
      <span onclick="event.stopPropagation();cycleStatus('${t.id}')" style="color:${sc};font-size:15px;flex-shrink:0;line-height:1.2;cursor:pointer;text-shadow:0 0 5px ${sc}66;">${STATUS_ICON[t.status]||"‚óã"}</span>
      <span style="width:5px;height:5px;border-radius:50%;flex-shrink:0;margin-top:6px;background:${PRIORITY_COLOR[t.priority]||'#555580'};box-shadow:0 0 4px ${PRIORITY_COLOR[t.priority]||'#555580'};"></span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:12px;color:${isSel?'#fff':'var(--text)'};line-height:1.3;">${esc(t.title)}</div>
        <div style="display:flex;gap:4px;margin-top:3px;align-items:center;flex-wrap:wrap;">
          ${overdue?`<span style="font-size:8px;color:#FF2020;background:rgba(255,32,32,0.12);border:1px solid rgba(255,32,32,0.3);padding:1px 5px;border-radius:2px;font-family:var(--font-hud);">‚ö† OVERDUE ${t.dueDate.slice(5)}</span>`:`<span style="font-size:8px;color:#FFD700;font-family:var(--font-hud);">‚è± TODAY</span>`}
          ${proj?`<span style="font-size:8px;color:${proj.color};font-family:var(--font-hud);">‚óà ${esc(proj.name)}</span>`:""}
          ${srcBadge}
        </div>
      </div>
      ${isSel?`<span style="color:#FF2020;font-size:12px;flex-shrink:0;margin-top:2px;">üéØ</span>`:""}
    </div>`;
  }

  function todaySection(label, color, taskArr){
    if(taskArr.length===0) return `<div style="font-size:10px;color:var(--text3);font-family:var(--font-hud);letter-spacing:1px;padding:6px 2px;font-style:italic;">‚Äî QUEST BOARD CLEAR ‚Äî</div>`;
    return taskArr.map(t=>todayTaskRow(t)).join("");
  }

  const workOverdueCount=workTasks.filter(t=>isOverdue(t)).length;
  const persOverdueCount=persTasks.filter(t=>isOverdue(t)).length;

  container.innerHTML=`<div>
    <!-- BATTLE PLANNER -->
    <div class="pomo-card" style="border-color:${mc}44;">
      <div class="pomo-header">
        <div class="pomo-title">üéØ BATTLE PLANNER</div>
        <div class="pomo-mode-btns">
          <button class="pomo-mbtn ${pomoState.mode==='work'?'active-work':''}" onclick="setPomoMode('work')">FOCUS</button>
          <button class="pomo-mbtn ${pomoState.mode==='shortBreak'?'active-shortBreak':''}" onclick="setPomoMode('shortBreak')">SHORT</button>
          <button class="pomo-mbtn ${pomoState.mode==='longBreak'?'active-longBreak':''}" onclick="setPomoMode('longBreak')">LONG</button>
        </div>
      </div>
      <div class="pomo-body">
        <div class="pomo-ring-wrap">
          <svg width="104" height="104" viewBox="0 0 104 104">
            <circle cx="52" cy="52" r="${R}" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="5"/>
            <circle cx="52" cy="52" r="${R-8}" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1" stroke-dasharray="3 5"/>
            <circle cx="52" cy="52" r="${R}" fill="none" stroke="${mc}" stroke-width="5"
              stroke-linecap="round" stroke-dasharray="${circ*pct} ${circ}"
              transform="rotate(-90 52 52)" style="filter:drop-shadow(0 0 5px ${mc});"/>
            ${pct>0.01&&pomoState.running?`<circle cx="${tipX}" cy="${tipY}" r="4" fill="${mc}" style="filter:drop-shadow(0 0 6px ${mc});"/>`:""}
            <line x1="52" y1="8" x2="52" y2="96" stroke="${mc}22" stroke-width="0.5"/>
            <line x1="8" y1="52" x2="96" y2="52" stroke="${mc}22" stroke-width="0.5"/>
          </svg>
          <div class="pomo-time">
            <div class="pomo-digits" style="color:${mc};text-shadow:0 0 10px ${mc}99;">${fmt(pomoState.timeLeft)}</div>
            <div class="pomo-mode-lbl" style="color:${mc};text-shadow:0 0 6px ${mc}66;">${ml}</div>
          </div>
        </div>
        <div class="pomo-controls">
          <div class="pomo-dots">
            ${dots.map(f=>`<div class="pomo-dot ${f?'filled':''}"></div>`).join("")}
            <span class="pomo-sessions">${pomoState.sessions} SORTIES</span>
          </div>
          <div class="pomo-btns">
            <button class="pomo-start" id="pomo-start-btn"
              style="background:${pomoState.running?'rgba(20,0,0,0.8)':`${mc}18`};border:1px solid ${mc};color:${mc};text-shadow:0 0 8px ${mc}99;box-shadow:${pomoState.running?'none':`0 0 14px ${mc}33`};"
              onclick="togglePomo()">
              ${pomoState.timeLeft===0?"‚Ü∫ RESET":pomoState.running?"‚è∏ HOLD":"‚ñ∂ ADVENTURE"}
            </button>
            <button class="pomo-reset" onclick="resetPomo()">‚Ü∫</button>
          </div>
          <div class="pomo-next">${pomoState.mode==="work"?`NEXT: ${pomoState.sessions%4===3?"LONG REST üõãÔ∏è":"SHORT REST ‚òï"}`:"NEXT: ADVENTURE üéØ"}</div>
        </div>
      </div>
      ${selHtml}
    </div>

    <!-- TODAY PANEL -->
    <div style="background:linear-gradient(135deg,rgba(8,8,24,0.98),rgba(5,5,18,0.99));border:1px solid var(--border2);border-radius:4px;padding:14px;margin-top:0;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div>
          <div style="font-family:var(--font-hud);font-size:11px;font-weight:900;color:var(--gold);letter-spacing:3px;text-shadow:0 0 8px rgba(255,215,0,0.3);">üìã TODAY'S QUESTS</div>
          <div style="font-size:9px;color:var(--text3);font-family:var(--font-hud);margin-top:2px;letter-spacing:1px;">TAP A QUEST TO TARGET IT</div>
        </div>
        <span style="background:${totalToday>0?'rgba(255,215,0,0.1)':'rgba(57,255,20,0.08)'};border:1px solid ${totalToday>0?'var(--gold2)':'rgba(57,255,20,0.3)'};color:${totalToday>0?'var(--gold)':'#39FF14'};font-family:var(--font-hud);font-size:12px;font-weight:900;padding:3px 12px;border-radius:2px;">${totalToday>0?totalToday+" LEFT":"BOARD CLEAR ‚úì"}</span>
      </div>

      <!-- WORK -->
      <div style="margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;padding-bottom:5px;border-bottom:1px solid rgba(0,191,255,0.2);">
          <span style="font-size:9px;font-family:var(--font-hud);font-weight:900;color:#00BFFF;letter-spacing:2px;">‚ö° REPUBLIC</span>
          ${workTasks.length>0?`<span style="font-size:9px;color:#00BFFF;font-family:var(--font-hud);">${workTasks.length} mission${workTasks.length>1?'s':''}</span>`:""}
          ${workOverdueCount>0?`<span style="font-size:8px;color:#FF2020;background:rgba(255,32,32,0.12);border:1px solid rgba(255,32,32,0.3);padding:1px 6px;border-radius:2px;font-family:var(--font-hud);">${workOverdueCount} OVERDUE</span>`:""}
        </div>
        ${todaySection("KINGDOM","#00BFFF",workTasks)}
      </div>

      <!-- PERSONAL -->
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;padding-bottom:5px;border-bottom:1px solid rgba(57,255,20,0.2);">
          <span style="font-size:9px;font-family:var(--font-hud);font-weight:900;color:#39FF14;letter-spacing:2px;">üåø PERSONAL</span>
          ${persTasks.length>0?`<span style="font-size:9px;color:#39FF14;font-family:var(--font-hud);">${persTasks.length} mission${persTasks.length>1?'s':''}</span>`:""}
          ${persOverdueCount>0?`<span style="font-size:8px;color:#FF2020;background:rgba(255,32,32,0.12);border:1px solid rgba(255,32,32,0.3);padding:1px 6px;border-radius:2px;font-family:var(--font-hud);">${persOverdueCount} OVERDUE</span>`:""}
        </div>
        ${todaySection("HOMESTEAD","#39FF14",persTasks)}
      </div>
    </div>
  </div>`;
}

function selectMission(id){
  selectedMissionId=selectedMissionId===id?null:id;
  renderAll();
  showToast(selectedMissionId?"üéØ QUEST TARGETED":"QUEST UNSELECTED");
}

function setPomoMode(mode){
  clearInterval(pomoState.interval);
  pomoState.mode=mode;
  pomoState.timeLeft=mode==="work"?pomoState.customWork*60:mode==="shortBreak"?300:900;
  pomoState.running=false;renderAll();
}

function togglePomo(){
  if(pomoState.timeLeft===0){resetPomo();return;}
  pomoState.running=!pomoState.running;
  if(pomoState.running){
    pomoState.interval=setInterval(()=>{
      pomoState.timeLeft--;
      if(pomoState.timeLeft<=0){
        clearInterval(pomoState.interval);pomoState.running=false;
        playBeep();
        if(pomoState.mode==="work"){
          pomoState.sessions++;
          const next=pomoState.sessions%4===0?"longBreak":"shortBreak";
          pomoState.mode=next;pomoState.timeLeft=next==="shortBreak"?300:900;
        }else{pomoState.mode="work";pomoState.timeLeft=pomoState.customWork*60;}
      }
      const d=document.querySelector(".pomo-digits");
      const fmt=s=>`${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
      if(d) d.textContent=fmt(pomoState.timeLeft);
      else{clearInterval(pomoState.interval);renderAll();}
    },1000);
  }else{clearInterval(pomoState.interval);}
  renderAll();
}

function resetPomo(){
  clearInterval(pomoState.interval);pomoState.running=false;
  pomoState.timeLeft=pomoState.mode==="work"?pomoState.customWork*60:pomoState.mode==="shortBreak"?300:900;
  renderAll();
}

function playBeep(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    // Imperial march-ish fanfare
    [{f:392,t:0},{f:392,t:0.18},{f:392,t:0.36},{f:311,t:0.54},{f:466,t:0.65}].forEach(({f,t})=>{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);
      o.frequency.value=f;o.type="square";
      g.gain.setValueAtTime(0.08,ctx.currentTime+t);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.15);
      o.start(ctx.currentTime+t);o.stop(ctx.currentTime+t+0.18);
    });
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REALM MAP (calendar)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar(container){
  const y=calendarDate.getFullYear(),m=calendarDate.getMonth();
  const firstDay=new Date(y,m,1).getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();
  const todayStr=today();
  const MONTHS=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  const DAYS=["SU","MO","TU","WE","TH","FR","SA"];
  const byDate={};
  tasks.forEach(t=>{
    if(!t.dueDate||t.status==="done") return;
    const k=t.dueDate.slice(0,10);if(!byDate[k])byDate[k]=[];byDate[k].push(t);
  });
  let gridHtml=DAYS.map(d=>`<div class="cal-day-hdr">${d}</div>`).join("");
  for(let i=0;i<firstDay;i++) gridHtml+=`<div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dt=byDate[ds]||[];
    const isToday=ds===todayStr;const isOverdue=ds<todayStr&&dt.length>0;
    let cls="cal-cell";
    if(dt.length>0) cls+=" has-tasks";
    if(isToday) cls+=" today";
    if(isOverdue) cls+=" overdue-day";
    const numCls=isToday?"today":isOverdue?"overdue":"normal";
    let chips=dt.slice(0,2).map(t=>{
      const proj=projects.find(p=>p.id===t.projectId);const c=proj?.color||"#FFD700";
      return `<div class="cal-chip" style="background:${c}18;color:${c};border:1px solid ${c}33;">${esc(t.title)}</div>`;
    }).join("");
    if(dt.length>2) chips+=`<div class="cal-more">+${dt.length-2}</div>`;
    gridHtml+=`<div class="${cls}" onclick="${dt.length>0?`calDayClick('${ds}')`:''}"}>
      <div class="cal-day-num ${numCls}">${d}</div>${chips}</div>`;
  }
  const upcoming=tasks.filter(t=>t.dueDate&&t.status!=="done")
    .sort((a,b)=>a.dueDate.localeCompare(b.dueDate)).slice(0,8);
  const upcomingHtml=upcoming.length===0
    ?`<div class="empty">‚Äî NO UPCOMING DEADLINES ‚Äî</div>`
    :upcoming.map(t=>{
        const proj=projects.find(p=>p.id===t.projectId);
        const overdue=t.dueDate<todayStr;const isT=t.dueDate===todayStr;
        const daysUntil=Math.ceil((new Date(t.dueDate)-new Date(todayStr))/86400000);
        const bb=overdue?"rgba(255,32,32,0.15)":isT?"rgba(255,215,0,0.1)":"var(--border)";
        const bc=overdue?"rgba(255,32,32,0.5)":isT?"var(--gold2)":"var(--border2)";
        const lc=overdue?"#FF2020":isT?"#FFD700":"#555580";
        const lbl=overdue?"‚ö† OVERDUE":isT?"‚òÖ TODAY":`${daysUntil}d`;
        return `<div class="upcoming-row" onclick="setNav('tasks');renderAll();">
          <div class="due-badge" style="background:${bb};border:1px solid ${bc};">
            <div class="due-badge-lbl" style="color:${lc};">${lbl}</div>
            <div class="due-badge-date" style="color:${overdue?'#FF8080':isT?'#FFD700':'#888899'};">${t.dueDate.slice(5)}</div>
          </div>
          <span class="priority-dot" style="background:${PRIORITY_COLOR[t.priority]||'#555580'};box-shadow:0 0 4px ${PRIORITY_COLOR[t.priority]||'#555580'};margin-top:0;"></span>
          <span style="flex:1;font-size:13px;color:var(--text);min-width:0;">${esc(t.title)}</span>
          ${proj?`<span style="font-size:8px;color:${proj.color};flex-shrink:0;font-family:var(--font-hud);letter-spacing:0.5px;">‚óà ${esc(proj.name)}</span>`:""}
        </div>`;
      }).join("");

  container.innerHTML=`
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calPrev()">‚Üê</button>
      <div class="cal-month">‚òÖ ${MONTHS[m]} ${y}</div>
      <button class="cal-nav-btn" onclick="calNext()">‚Üí</button>
    </div>
    <div class="cal-grid">${gridHtml}</div>
    <div class="upcoming-card">
      <div class="upcoming-title">‚è± QUEST DEADLINES</div>
      ${upcomingHtml}
    </div>`;
}

function calPrev(){calendarDate=new Date(calendarDate.getFullYear(),calendarDate.getMonth()-1,1);renderAll();}
function calNext(){calendarDate=new Date(calendarDate.getFullYear(),calendarDate.getMonth()+1,1);renderAll();}
function calDayClick(ds){setNav("tasks");renderAll();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUILD HALL SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEL ANALYTICS (CHARTS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chartRange=30; // days

function renderCharts(container){
  const now=Date.now();
  const msDay=86400000;
  const ranges=[30,90,180,365];
  const rangeLabels={"30":"30 DAYS","90":"90 DAYS","180":"6 MONTHS","365":"1 YEAR"};

  // Filter tasks completed within range
  function inRange(t,days){
    if(t.status!=="done") return false;
    // use createdAt as proxy if no completedAt ‚Äî good enough
    const ts=t.completedAt||t.createdAt||0;
    return (now - Number(ts)) <= days*msDay;
  }
  function allInRange(days){
    return tasks.filter(t=>inRange(t,days));
  }

  const completed=allInRange(chartRange);
  const totalActive=tasks.filter(t=>t.status!=="done").length;
  const totalDone=tasks.filter(t=>t.status==="done").length;
  const totalBlocked=tasks.filter(t=>t.status==="blocked").length;

  // ‚îÄ‚îÄ Summary stats
  const statsHtml=`
    <div class="chart-stat-row">
      <div class="chart-stat">
        <div class="chart-stat-num" style="color:#39FF14;">${completed.length}</div>
        <div class="chart-stat-lbl">COMPLETED</div>
      </div>
      <div class="chart-stat">
        <div class="chart-stat-num" style="color:#FFD700;">${totalActive}</div>
        <div class="chart-stat-lbl">ACTIVE</div>
      </div>
      <div class="chart-stat">
        <div class="chart-stat-num" style="color:#FF2020;">${totalBlocked}</div>
        <div class="chart-stat-lbl">BLOCKED</div>
      </div>
      <div class="chart-stat">
        <div class="chart-stat-num" style="color:#00BFFF;">${tasks.length}</div>
        <div class="chart-stat-lbl">TOTAL</div>
      </div>
    </div>`;

  // ‚îÄ‚îÄ Completed over time (weekly bars)
  function weeklyBars(){
    const weeks=Math.ceil(chartRange/7);
    const buckets=[];
    for(let i=weeks-1;i>=0;i--){
      const end=now-(i*7*msDay);
      const start=end-(7*msDay);
      const lbl=new Date(start);
      const label=(lbl.getMonth()+1)+"/"+(lbl.getDate());
      const count=tasks.filter(t=>{
        if(t.status!=="done") return false;
        const ts=t.completedAt||t.createdAt||0;
        return Number(ts)>=start && Number(ts)<end;
      }).length;
      buckets.push({label,count});
    }
    const max=Math.max(...buckets.map(b=>b.count),1);
    const barW=Math.max(24, Math.floor((window.innerWidth-80)/buckets.length)-4);
    const svgW=buckets.length*(barW+4);
    const svgH=90;
    const bars=buckets.map((b,i)=>{
      const h=Math.round((b.count/max)*(svgH-24));
      const x=i*(barW+4);
      const y=svgH-24-h;
      return `<g>
        <rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="2"
          fill="${b.count>0?'rgba(57,255,20,0.7)':'rgba(57,255,20,0.1)'}"/>
        <text x="${x+barW/2}" y="${svgH-10}" text-anchor="middle" font-size="8"
          fill="#555580" font-family="monospace">${b.label}</text>
        ${b.count>0?`<text x="${x+barW/2}" y="${y-3}" text-anchor="middle" font-size="9"
          fill="#39FF14" font-family="monospace">${b.count}</text>`:""}
      </g>`;
    }).join("");
    return `<div class="sparkline-wrap"><svg width="${svgW}" height="${svgH}" style="display:block;">${bars}</svg></div>`;
  }

  // ‚îÄ‚îÄ Donut chart (pure SVG)
  function donut(slices, cx=70, cy=70, r=50, ir=32){
    let total=slices.reduce((s,x)=>s+x.val,0);
    if(total===0) return `<text x="${cx}" y="${cy+5}" text-anchor="middle" font-size="11" fill="#555580" font-family="monospace">NO DATA</text>`;
    let angle=-Math.PI/2;
    const paths=slices.filter(s=>s.val>0).map(s=>{
      const sweep=(s.val/total)*2*Math.PI;
      const x1=cx+r*Math.cos(angle), y1=cy+r*Math.sin(angle);
      angle+=sweep;
      const x2=cx+r*Math.cos(angle), y2=cy+r*Math.sin(angle);
      const ix1=cx+ir*Math.cos(angle-sweep), iy1=cy+ir*Math.sin(angle-sweep);
      const ix2=cx+ir*Math.cos(angle), iy2=cy+ir*Math.sin(angle);
      const lg=sweep>Math.PI?1:0;
      return `<path d="M${x1},${y1} A${r},${r} 0 ${lg},1 ${x2},${y2} L${ix2},${iy2} A${ir},${ir} 0 ${lg},0 ${ix1},${iy1} Z"
        fill="${s.color}" opacity="0.85"/>`;
    }).join("");
    const totalLbl=`<text x="${cx}" y="${cy-5}" text-anchor="middle" font-size="16" font-weight="bold" fill="#FFD700" font-family="monospace">${total}</text>
      <text x="${cx}" y="${cy+10}" text-anchor="middle" font-size="8" fill="#555580" font-family="monospace">TOTAL</text>`;
    return paths+totalLbl;
  }

  // ‚îÄ‚îÄ Status donut
  const statusSlices=[
    {label:"PENDING", val:tasks.filter(t=>t.status==="todo").length,    color:"#555580"},
    {label:"ADVENTURED", val:tasks.filter(t=>t.status==="inprogress").length, color:"#FFD700"},
    {label:"BLOCKED", val:tasks.filter(t=>t.status==="blocked").length,  color:"#FF2020"},
    {label:"COMPLETE",val:totalDone, color:"#39FF14"},
  ];
  const statusDonut=`<div class="donut-wrap">
    <svg width="140" height="140" style="flex-shrink:0;">${donut(statusSlices)}</svg>
    <div class="donut-legend">${statusSlices.map(s=>`
      <div class="donut-legend-item">
        <div class="donut-legend-dot" style="background:${s.color};box-shadow:0 0 4px ${s.color};"></div>
        <span>${s.label}</span>
        <span style="margin-left:auto;color:${s.color};font-weight:900;">${s.val}</span>
      </div>`).join("")}
    </div></div>`;

  // ‚îÄ‚îÄ Priority donut (active tasks only)
  const activeTasks=tasks.filter(t=>t.status!=="done");
  const prioSlices=[
    {label:"DRAGON",   val:activeTasks.filter(t=>t.priority==="high").length,   color:"#8B2020"},
    {label:"ORC",      val:activeTasks.filter(t=>t.priority==="medium").length,  color:"#D4A017"},
    {label:"GOBLIN",   val:activeTasks.filter(t=>t.priority==="low").length,     color:"#5C5C40"},
  ];
  const prioDonut=`<div class="donut-wrap">
    <svg width="140" height="140" style="flex-shrink:0;">${donut(prioSlices)}</svg>
    <div class="donut-legend">${prioSlices.map(s=>`
      <div class="donut-legend-item">
        <div class="donut-legend-dot" style="background:${s.color};box-shadow:0 0 4px ${s.color};"></div>
        <span>${s.label}</span>
        <span style="margin-left:auto;color:${s.color};font-weight:900;">${s.val}</span>
      </div>`).join("")}
    </div></div>`;

  // ‚îÄ‚îÄ By squadron bars
  function squadronBars(){
    const projData=projects.map(p=>{
      const pt=tasks.filter(t=>t.projectId===p.id);
      const done=pt.filter(t=>t.status==="done").length;
      const active=pt.filter(t=>t.status!=="done").length;
      return {name:p.name,color:p.color||"#FFD700",done,active,total:pt.length};
    }).filter(p=>p.total>0).sort((a,b)=>b.total-a.total);
    const max=Math.max(...projData.map(p=>p.total),1);
    return projData.map(p=>`
      <div class="bar-row">
        <div class="bar-label" title="${p.name}">${p.name}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${Math.round(p.done/max*100)}%;background:${p.color};opacity:0.8;"></div>
        </div>
        <div class="bar-count" style="color:${p.color};">${p.done}<span style="color:var(--text4);">/${p.total}</span></div>
      </div>`).join("");
  }

  // ‚îÄ‚îÄ By intel source bars
  function effortBars(){
    const effortData=DIFFICULTY_LEVELS.map(e=>{
      const all=tasks.filter(t=>t.effort===e.val);
      const done=all.filter(t=>t.status==="done").length;
      return {label:e.icon+' '+e.label,color:e.color,total:all.length,done};
    }).filter(e=>e.total>0);
    if(!effortData.length) return "";
    const max=Math.max(...effortData.map(e=>e.total),1);
    return effortData.map(e=>`
      <div class="bar-row">
        <div class="bar-label">${e.label}</div>
        <div class="bar-track" style="position:relative;">
          <div style="position:absolute;top:0;left:0;width:${Math.round(e.total/max*100)}%;height:100%;background:${e.color};opacity:0.18;border-radius:2px;"></div>
          <div class="bar-fill" style="width:${Math.round(e.done/max*100)}%;background:${e.color};opacity:0.8;position:relative;"></div>
        </div>
        <div class="bar-count" style="color:${e.color};">${e.done}<span style="color:var(--text4);">/${e.total}</span></div>
      </div>`).join("");
  }

  // Effort donut (all tasks)
  const effortSlices=DIFFICULTY_LEVELS.map(e=>({
    label:e.label, val:tasks.filter(t=>t.effort===e.val).length, color:e.color
  }));
  const effortDonut=`<div class="donut-wrap">
    <svg width="140" height="140" style="flex-shrink:0;">${donut(effortSlices)}</svg>
    <div class="donut-legend">${effortSlices.map(s=>`
      <div class="donut-legend-item">
        <div class="donut-legend-dot" style="background:${s.color};box-shadow:0 0 4px ${s.color};"></div>
        <span>${s.label}</span>
        <span style="margin-left:auto;color:${s.color};font-weight:900;">${s.val}</span>
      </div>`).join("")}
    </div></div>`;

  function sourceBars(){
    const srcData=SOURCE_OPTIONS.map(s=>{
      const count=tasks.filter(t=>t.source===s.val).length;
      const done=tasks.filter(t=>t.source===s.val&&t.status==="done").length;
      return {label:s.icon+" "+s.label,color:s.color,count,done};
    }).filter(s=>s.count>0).sort((a,b)=>b.count-a.count);
    const max=Math.max(...srcData.map(s=>s.count),1);
    return srcData.map(s=>`
      <div class="bar-row">
        <div class="bar-label">${s.label}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${Math.round(s.done/max*100)}%;background:${s.color};opacity:0.7;"></div>
          <div class="bar-fill" style="position:absolute;top:0;left:0;width:${Math.round(s.count/max*100)}%;background:${s.color};opacity:0.2;height:100%;border-radius:2px;"></div>
        </div>
        <div class="bar-count" style="color:${s.color};">${s.done}<span style="color:var(--text4);">/${s.count}</span></div>
      </div>`).join("");
  }

  // ‚îÄ‚îÄ Range buttons
  const rangeBtns=ranges.map(r=>`
    <button class="crng${chartRange===r?' active':''}" onclick="setChartRange(${r})">${rangeLabels[r]}</button>`).join("");

  container.innerHTML=`<div class="charts-screen">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:4px;">
      <div style="font-family:var(--font-hud);font-size:11px;font-weight:900;color:var(--gold);letter-spacing:3px;">üìú CHRONICLES</div>
      <div class="chart-range-bar">${rangeBtns}</div>
    </div>

    <!-- Summary stats -->
    <div class="chart-card">
      <div class="chart-card-title">‚óà GUILD OVERVIEW</div>
      ${statsHtml}
    </div>

    <!-- Completed over time -->
    <div class="chart-card">
      <div class="chart-card-title">‚óà QUESTS COMPLETED ‚Äî LAST ${rangeLabels[String(chartRange)]} (BY WEEK)</div>
      ${weeklyBars()}
    </div>

    <!-- Status + Priority side by side -->
    <div style="display:flex;gap:10px;">
      <div class="chart-card" style="flex:1;min-width:0;">
        <div class="chart-card-title">‚óà BY STATUS</div>
        ${statusDonut}
      </div>
      <div class="chart-card" style="flex:1;min-width:0;">
        <div class="chart-card-title">‚óà BY PRIORITY</div>
        ${prioDonut}
      </div>
    </div>

    <!-- By squadron -->
    <div class="chart-card">
      <div class="chart-card-title">‚óà BY PARTY <span style="font-size:8px;color:var(--text3);font-weight:400;">(DONE / TOTAL)</span></div>
      ${squadronBars()||'<div style="color:var(--text4);font-size:11px;font-family:var(--font-hud);">NO DATA</div>'}
    </div>

    <!-- Effort donut + effort bars -->
    <div style="display:flex;gap:10px;">
      <div class="chart-card" style="flex:1;min-width:0;">
        <div class="chart-card-title">‚óà BY QUEST DIFFICULTY</div>
        ${effortDonut}
      </div>
    </div>

    <!-- Effort bars breakdown -->
    <div class="chart-card">
      <div class="chart-card-title">‚óà DIFFICULTY BREAKDOWN <span style="font-size:8px;color:var(--text3);font-weight:400;">(DONE / TOTAL)</span></div>
      ${effortBars()||'<div style="color:var(--text4);font-size:11px;font-family:var(--font-hud);">NO DATA ‚Äî SET QUEST SIZE ON YOUR TASKS</div>'}
    </div>

    <!-- By intel source -->
    <div class="chart-card" style="margin-bottom:20px;">
      <div class="chart-card-title">‚óà BY QUEST GIVER <span style="font-size:8px;color:var(--text3);font-weight:400;">(DONE / TOTAL)</span></div>
      ${sourceBars()||'<div style="color:var(--text4);font-size:11px;font-family:var(--font-hud);">NO DATA</div>'}
    </div>
  </div>`;
}

function setChartRange(days){
  chartRange=days;
  const main=document.getElementById("main");
  renderCharts(main);
}

function renderSettings(container){
  container.innerHTML=`
    <div style="margin-bottom:16px;">
      <div class="section-title">‚óà PARTIES</div>
      ${projects.map(p=>`
        <div style="display:flex;align-items:center;gap:8px;padding:9px 0;border-bottom:1px solid var(--border);">
          <span style="width:8px;height:8px;border-radius:50%;background:${p.color};flex-shrink:0;display:inline-block;box-shadow:0 0 6px ${p.color};"></span>
          <span style="flex:1;font-size:11px;font-family:var(--font-hud);letter-spacing:1px;color:${p.color};">${esc(p.name)}</span>
          <span style="font-size:9px;color:var(--text3);font-family:var(--font-hud);">${p.domain==="work"?"KINGDOM":"HOMESTEAD"}</span>
        </div>`).join("")}
      <button class="hbtn" style="margin-top:10px;width:100%;" onclick="openAddProject()">+ CHARTER PARTY</button>
    </div>
    <div style="margin-bottom:16px;">
      <div class="section-title">‚¨Ü TOME IMPORT (CSV)</div>
      <div class="import-zone" onclick="document.getElementById('csv-file-input').click()">
        <div style="font-size:24px;margin-bottom:6px;">üì°</div>
        <div style="font-size:11px;color:var(--text2);font-family:var(--font-hud);letter-spacing:1px;">TAP TO IMPORT TOME DATA</div>
        <div style="font-size:10px;color:var(--text3);margin-top:3px;">COLUMNS: title, project, domain, priority, status, dueDate, notes, source</div>
      </div>
      <div id="import-preview-area"></div>
    </div>
    <div style="margin-bottom:16px;">
      <div class="section-title">üì° GUILD ARCHIVES LINK</div>
      <button class="hbtn" style="width:100%;margin-bottom:8px;" onclick="syncNow()">‚Üª SYNC WITH ARCHIVES</button>
      <button class="hbtn" style="width:100%;margin-bottom:8px;border-color:#00BFFF;color:#00BFFF;" onclick="runDiagnostic()">üî¨ DIVINE ARCHIVES</button>
      <button class="hbtn" style="width:100%;margin-bottom:8px;border-color:var(--gold);color:var(--gold);" onclick="forcePushToSheets()">‚¨Ü INSCRIBE ALL LOCAL DATA</button>
      <div style="font-size:10px;color:var(--text3);line-height:1.7;font-family:var(--font-hud);letter-spacing:0.5px;">
        USE "INSCRIBE ALL" IF GUILD ARCHIVES APPEAR EMPTY.
        QUESTS SYNC AUTOMATICALLY WITHIN ~1 SECOND.
      </div>
    </div>
    <div style="margin-bottom:32px;">
      <div class="section-title">üéØ BATTLE PLANNER CONFIG</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:10px;color:var(--text3);font-family:var(--font-hud);letter-spacing:0.5px;white-space:nowrap;">FOCUS TIME:</span>
        <input type="range" min="5" max="60" value="${pomoState.customWork}"
          style="flex:1;accent-color:var(--saber-red);"
          oninput="pomoState.customWork=Number(this.value);document.getElementById('pomo-dur-lbl').textContent=this.value+'m'"/>
        <span id="pomo-dur-lbl" style="font-size:11px;color:var(--gold);min-width:32px;font-family:var(--font-hud);">${pomoState.customWork}m</span>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUEST ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleExpand(id){expandedTaskId=expandedTaskId===id?null:id;renderAll();}

function cycleStatus(id){
  const order=["todo","inprogress","blocked","done"];
  const t=tasks.find(t=>t.id===id);if(!t) return;
  const prev=t.status;
  t.status=order[(order.indexOf(t.status)+1)%order.length];
  if(t.status==="done"&&prev!=="done"){
    t.completedAt=Date.now();
    if(t.recur&&t.recur!=="none") spawnRecurringCopy(t);
  }
  if(t.status!=="done") t.completedAt=null;
  saveAllDebounced();renderAll();
  showToast(STATUS_LABEL[t.status]);
}

function spawnRecurringCopy(t){
  const nextDue=calcNextDue(t.dueDate||today(),t.recur);
  tasks.push({id:genId(),projectId:t.projectId,title:t.title,priority:t.priority,
    status:"todo",notes:t.notes||"",dueDate:nextDue,source:t.source||"",
    recur:t.recur,effort:t.effort||"",createdAt:Date.now()});
  showToast("üîÅ NEXT QUEST SCHEDULED: "+nextDue.slice(5));
}

function calcNextDue(fromDate,recur){
  const d=new Date(fromDate+"T00:00:00");
  if(recur==="daily")    d.setDate(d.getDate()+1);
  if(recur==="weekly")   d.setDate(d.getDate()+7);
  if(recur==="biweekly") d.setDate(d.getDate()+14);
  if(recur==="monthly")  d.setMonth(d.getMonth()+1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function updateTaskField(id,field,val){
  const t=tasks.find(t=>t.id===id);if(!t) return;
  if(field==="status"){
    if(val==="done"&&t.status!=="done") t.completedAt=Date.now();
    if(val!=="done") t.completedAt=null;
  }
  t[field]=val;saveAllDebounced();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG-AND-DROP PROJECT REORDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onProjDragStart(e,id){
  dragSrcId=id;
  e.dataTransfer.effectAllowed="move";
  setTimeout(()=>{const el=document.getElementById("pcard-"+id);if(el)el.classList.add("dragging");},0);
}
function onProjDragOver(e,id){
  e.preventDefault();e.dataTransfer.dropEffect="move";
  if(id===dragSrcId) return;
  document.querySelectorAll(".project-card").forEach(c=>c.classList.remove("drag-over"));
  const el=document.getElementById("pcard-"+id);if(el)el.classList.add("drag-over");
}
function onProjDragLeave(e,id){
  const el=document.getElementById("pcard-"+id);if(el)el.classList.remove("drag-over");
}
function onProjDrop(e,targetId){
  e.preventDefault();
  if(!dragSrcId||dragSrcId===targetId) return;
  const src=projects.find(p=>p.id===dragSrcId);
  const tgt=projects.find(p=>p.id===targetId);
  if(!src||!tgt) return;
  projects.splice(projects.indexOf(src),1);
  projects.splice(projects.indexOf(tgt),0,src);
  saveAllDebounced();dragSrcId=null;renderAll();
}
function onProjDragEnd(){
  dragSrcId=null;
  document.querySelectorAll(".project-card").forEach(c=>c.classList.remove("dragging","drag-over"));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RICH NOTES EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function noteCmd(cmd){
  document.getElementById("task-notes-input").focus();
  document.execCommand(cmd,false,null);
}
function insertCheckbox(){
  const editor=document.getElementById("task-notes-input");editor.focus();
  const id="chk-"+Math.random().toString(36).substr(2,6);
  document.execCommand("insertHTML",false,`<div class="task-check" contenteditable="false"><input type="checkbox" id="${id}" onchange="this.nextElementSibling.className=this.checked?'checked':''"><span contenteditable="true"> New item</span></div><br>`);
}
function insertExpandCheckbox(taskId){
  const editor=document.getElementById("enotes-"+taskId);if(!editor)return;editor.focus();
  const id="chk-"+Math.random().toString(36).substr(2,6);
  document.execCommand("insertHTML",false,`<div class="task-check" contenteditable="false"><input type="checkbox" id="${id}" onchange="this.nextElementSibling.className=this.checked?'checked':''"><span contenteditable="true"> New item</span></div><br>`);
}
function expandNoteCmd(taskId,cmd){
  const editor=document.getElementById("enotes-"+taskId);if(!editor)return;
  editor.focus();document.execCommand(cmd,false,null);
}

function toggleProject(id){
  const p=projects.find(p=>p.id===id);if(!p) return;
  p.collapsed=!p.collapsed;saveAllDebounced();renderAll();
}

function openAddTask(projectId=""){
  editingTaskId=null;
  document.getElementById("modal-task-title").textContent="‚äï NEW QUEST";
  document.getElementById("task-title-input").value="";
  document.getElementById("task-priority-input").value="medium";
  document.getElementById("task-status-input").value="todo";
  document.getElementById("task-due-input").value="";
  document.getElementById("task-notes-input").innerHTML="";
  window._editingSource="";window._editingRecur="none";window._editingEffort="";
  renderSourceChips("");renderRecurChips("none");renderEffortChips("");
  document.getElementById("task-delete-wrap").style.display="none";
  document.getElementById("task-save-btn").textContent="INSCRIBE";
  const sel=document.getElementById("task-project-input");
  sel.innerHTML=`<option value="">SELECT PARTY‚Ä¶</option>`+
    projects.map(p=>`<option value="${p.id}" ${p.id===projectId?"selected":""}>${esc(p.name)}</option>`).join("");
  openModal("modal-task");
  setTimeout(()=>document.getElementById("task-title-input").focus(),300);
}

function openEditTask(id){
  const t=tasks.find(t=>t.id===id);if(!t) return;
  editingTaskId=id;
  document.getElementById("modal-task-title").textContent="‚úè EDIT QUEST";
  document.getElementById("task-title-input").value=t.title;
  document.getElementById("task-priority-input").value=t.priority;
  document.getElementById("task-status-input").value=t.status;
  document.getElementById("task-due-input").value=t.dueDate||"";
  document.getElementById("task-notes-input").innerHTML=t.notes||"";
  window._editingSource=t.source||"";window._editingRecur=t.recur||"none";window._editingEffort=t.effort||"";
  renderSourceChips(t.source||"");renderRecurChips(t.recur||"none");renderEffortChips(t.effort||"");
  document.getElementById("task-delete-wrap").style.display="block";
  document.getElementById("task-save-btn").textContent="UPDATE";
  const sel=document.getElementById("task-project-input");
  sel.innerHTML=`<option value="">SELECT PARTY‚Ä¶</option>`+
    projects.map(p=>`<option value="${p.id}" ${p.id===t.projectId?"selected":""}>${esc(p.name)}</option>`).join("");
  openModal("modal-task");
}

function saveTask(){
  const title=document.getElementById("task-title-input").value.trim();
  const projectId=document.getElementById("task-project-input").value;
  if(!title){showToast("QUEST TITLE REQUIRED");return;}
  if(!projectId){showToast("ASSIGN TO A PARTY");return;}
  if(editingTaskId){
    const t=tasks.find(t=>t.id===editingTaskId);if(!t) return;
    t.title=title;t.projectId=projectId;
    t.priority=document.getElementById("task-priority-input").value;
    t.status=document.getElementById("task-status-input").value;
    t.dueDate=document.getElementById("task-due-input").value;
    t.notes=document.getElementById("task-notes-input").innerHTML;
    t.source=window._editingSource||"";
    t.recur=window._editingRecur||"none";
    t.effort=window._editingEffort||"";
    showToast("QUEST UPDATED ‚úì");
  }else{
    tasks.push({id:genId(),title,projectId,
      priority:document.getElementById("task-priority-input").value,
      status:document.getElementById("task-status-input").value,
      dueDate:document.getElementById("task-due-input").value,
      notes:document.getElementById("task-notes-input").innerHTML,
      source:window._editingSource||"",
      recur:window._editingRecur||"none",
      effort:window._editingEffort||"",
      createdAt:Date.now()});
    showToast("QUEST LOGGED ‚úì");
  }
  saveAllDebounced();closeModal("modal-task");renderAll();
}

function renderEffortChips(selected){
  const wrap=document.getElementById("effort-chips");if(!wrap) return;
  window._editingEffort=selected||"";
  wrap.innerHTML=DIFFICULTY_LEVELS.map(e=>{
    const active=e.val===(selected||"");
    return `<button class="effort-chip${active?' active-'+e.val:''}" onclick="renderEffortChips('${e.val}')">
      <span class="ec-icon">${e.icon}</span>
      <span class="ec-lbl">${e.label}</span>
    </button>`;
  }).join('');
}

function renderRecurChips(selected){
  const wrap=document.getElementById("recur-chips");if(!wrap) return;
  window._editingRecur=selected||"none";
  const opts=[
    {val:"none",   label:"OFF"},
    {val:"daily",  label:"üîÅ DAILY"},
    {val:"weekly", label:"üîÅ WEEKLY"},
    {val:"biweekly",label:"üîÅ BI-WEEKLY"},
    {val:"monthly",label:"üîÅ MONTHLY"},
  ];
  wrap.innerHTML=opts.map(o=>{
    const active=o.val===(selected||"none");
    return `<button class="recur-chip${active?' active':''}" onclick="renderRecurChips('${o.val}')">${o.label}</button>`;
  }).join('');
}

function renderSourceChips(selected){
  const wrap=document.getElementById("source-chips");if(!wrap) return;
  window._editingSource=selected;
  wrap.innerHTML=SOURCE_OPTIONS.map(s=>{
    const active=s.val===selected;
    return `<button onclick="renderSourceChips('${s.val}')" style="padding:4px 9px;border-radius:2px;border:1px solid ${active?s.color:'var(--border2)'};background:${active?s.color+'22':'transparent'};color:${active?s.color:'var(--text3)'};font-size:10px;font-family:var(--font-hud);letter-spacing:0.5px;cursor:pointer;transition:all 0.15s;">${s.icon} ${s.label}</button>`;
  }).join('');
}
function updateTaskSource(id,val){
  const t=tasks.find(t=>t.id===id);if(!t) return;
  t.source=val;saveAllDebounced();renderAll();
}
function confirmDeleteTask(id){
  if(confirm("ABANDON THIS QUEST?")){ 
    tasks=tasks.filter(t=>t.id!==id);
    expandedTaskId=null;saveAllDebounced();closeModal("modal-task");renderAll();
    showToast("QUEST REMOVED");
  }
}
function deleteCurrentTask(){if(editingTaskId) confirmDeleteTask(editingTaskId);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTY ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddProject(){
  selectedProjColor=PROJECT_COLORS[0];
  document.getElementById("proj-name-input").value="";
  document.getElementById("proj-domain-input").value="work";
  renderSwatches();openModal("modal-project");
  setTimeout(()=>document.getElementById("proj-name-input").focus(),300);
}

function renderSwatches(){
  const wrap=document.getElementById("proj-color-swatches");if(!wrap) return;
  wrap.innerHTML=PROJECT_COLORS.map(c=>
    `<div class="swatch ${c===selectedProjColor?'selected':''}" style="background:${c};box-shadow:0 0 8px ${c}66;"
      onclick="selectColor('${c}')"></div>`
  ).join("");
}

function selectColor(c){selectedProjColor=c;renderSwatches();}

function saveProject(){
  const name=document.getElementById("proj-name-input").value.trim();
  if(!name){showToast("PARTY NAME REQUIRED");return;}
  projects.push({id:genId(),name,domain:document.getElementById("proj-domain-input").value,color:selectedProjColor,collapsed:false});
  saveAllDebounced();closeModal("modal-project");renderAll();showToast("PARTY CHARTERED ‚úì");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSV INTEL IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleCSV(e){
  const file=e.target.files[0];if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{importPreviewData=parseCSV(ev.target.result);renderImportPreview();};
  reader.readAsText(file);e.target.value="";
}

function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  if(lines.length<2) return{error:"CSV MUST HAVE HEADER AND DATA ROWS."};
  const rawH=lines[0].split(",").map(h=>h.trim().toLowerCase().replace(/[^a-z0-9]/g,""));
  const alias={
    title:["title","task","name"],project:["project","projectname","section","group","category"],
    domain:["domain","type","area"],priority:["priority","prio"],status:["status","state"],
    dueDate:["duedate","due","deadline"],notes:["notes","note","description"],
  };
  const ci={};
  for(const[f,alts]of Object.entries(alias)) ci[f]=rawH.findIndex(h=>alts.includes(h));
  if(ci.title===-1) return{error:"CSV REQUIRES A 'title' COLUMN."};
  if(ci.project===-1) return{error:"CSV REQUIRES A 'project' COLUMN."};
  const splitRow=row=>{const c=[];let cur="",inQ=false;for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){inQ=!inQ;continue;}if(ch===","&&!inQ){c.push(cur.trim());cur="";continue;}cur+=ch;}c.push(cur.trim());return c;};
  const newProjMap={};const newTasks=[];const errors=[];
  for(let i=1;i<lines.length;i++){
    const raw=lines[i].trim();if(!raw) continue;
    const cells=splitRow(raw);
    const get=idx=>(idx>=0&&idx<cells.length)?cells[idx].trim():"";
    const title=get(ci.title);if(!title){errors.push(`ROW ${i+1}: MISSING TITLE`);continue;}
    const projName=get(ci.project)||"UNASSIGNED";
    const domain=get(ci.domain).toLowerCase()==="personal"?"personal":"work";
    const existing=projects.find(p=>p.name.toLowerCase()===projName.toLowerCase());
    let projectId;
    if(existing){projectId=existing.id;}
    else{
      const k=projName.toLowerCase();
      if(!newProjMap[k]) newProjMap[k]={id:genId(),name:projName,domain,color:PROJECT_COLORS[Object.keys(newProjMap).length%PROJECT_COLORS.length],collapsed:false};
      projectId=newProjMap[k].id;
    }
    const pr=get(ci.priority).toLowerCase();
    const priority=["high","medium","low"].includes(pr)?pr:"medium";
    const sr=get(ci.status).toLowerCase().replace(/\s/g,"");
    const statusMap={todo:"todo",inprogress:"inprogress","in-progress":"inprogress",blocked:"blocked",done:"done",complete:"done",completed:"done"};
    newTasks.push({id:genId(),projectId,title,priority,status:statusMap[sr]||"todo",notes:get(ci.notes),dueDate:get(ci.dueDate),createdAt:Date.now()});
  }
  return{newProjects:Object.values(newProjMap),newTasks,errors};
}

function renderImportPreview(){
  const area=document.getElementById("import-preview-area");if(!area) return;
  const d=importPreviewData;
  if(d.error){area.innerHTML=`<div style="color:var(--saber-red);font-size:11px;padding:10px 0;font-family:var(--font-hud);letter-spacing:1px;">‚ö† ${esc(d.error)}</div>`;return;}
  area.innerHTML=`
    <div class="preview-summary" style="margin-top:10px;">
      <div class="preview-stat" style="background:rgba(57,255,20,0.06);border:1px solid rgba(57,255,20,0.2);">
        <div class="preview-stat-num" style="color:var(--saber-green);">${d.newTasks.length}</div>
        <div class="preview-stat-lbl">QUESTS</div>
      </div>
      <div class="preview-stat" style="background:rgba(0,191,255,0.06);border:1px solid rgba(0,191,255,0.2);">
        <div class="preview-stat-num" style="color:var(--saber-blue);">${d.newProjects.length}</div>
        <div class="preview-stat-lbl">PARTYS</div>
      </div>
    </div>
    ${d.newTasks.slice(0,4).map(t=>{
      const proj=projects.find(p=>p.id===t.projectId)||d.newProjects.find(p=>p.id===t.projectId);
      return `<div class="preview-task-row">
        <span style="width:5px;height:5px;border-radius:50%;background:${PRIORITY_COLOR[t.priority]};flex-shrink:0;box-shadow:0 0 4px ${PRIORITY_COLOR[t.priority]};"></span>
        <span style="flex:1;color:var(--text);">${esc(t.title)}</span>
        ${proj?`<span style="color:${proj.color};font-size:9px;font-family:var(--font-hud);">‚óà ${esc(proj.name)}</span>`:""}
      </div>`;
    }).join("")}
    ${d.newTasks.length>4?`<div style="font-size:10px;color:var(--text3);padding:4px 0;font-family:var(--font-hud);">‚Ä¶AND ${d.newTasks.length-4} MORE QUESTS</div>`:""}
    <button class="modal-btn confirm" style="width:100%;margin-top:10px;" onclick="confirmImport()">
      ‚úì UPLOAD ${d.newTasks.length} QUESTS
    </button>`;
}

function confirmImport(){
  if(!importPreviewData||importPreviewData.error) return;
  projects=[...projects,...importPreviewData.newProjects];
  tasks=[...tasks,...importPreviewData.newTasks];
  saveAllDebounced();importPreviewData=null;
  const area=document.getElementById("import-preview-area");
  if(area) area.innerHTML=`<div style="color:var(--saber-green);font-size:11px;padding:10px 0;font-family:var(--font-hud);letter-spacing:1px;">‚úì INTEL UPLOAD COMPLETE</div>`;
  renderAll();showToast("INTEL UPLOADED ‚úì");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV + FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setNav(nav){
  activeNav=nav;focusOn=nav==="focus";
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  const btn=document.getElementById(`nav-${nav}`);if(btn) btn.classList.add("active");
  if(nav==="cal") viewMode="calendar";
  else if(nav==="tasks") viewMode="list";
  // Update focus button label
  const fb=document.getElementById("btn-focus");
  if(fb) fb.textContent=focusOn?"‚öî WAR ROOM":"ADVENTURE";
  if(focusOn) fb.classList.add("engaged"); else fb.classList.remove("engaged");
  renderAll();
}

function toggleFocus(){if(activeNav==="focus") setNav("tasks"); else setNav("focus");}

function setDomainFilter(f){
  domainFilter=f;
  ["all","work","personal"].forEach(v=>{
    const b=document.getElementById(`f-${v}`);if(!b) return;
    b.className="fbtn";
    if(v===f) b.className+=v==="work"?" active-work":v==="personal"?" active-personal":" active-all";
  });renderAll();
}

function setStatusFilter(f){
  statusFilter=f;
  ["active","all","done"].forEach(v=>{
    const b=document.getElementById(`fs-${v}`);if(!b) return;
    b.className="fbtn"+(v===f?" active-status":"");
  });renderAll();
}

function setView(v){
  viewMode=v;if(v==="calendar") activeNav="cal"; else activeNav="tasks";
  ["list","cal"].forEach(vv=>{
    const b=document.getElementById(`fv-${vv}`);if(!b) return;
    b.className="fbtn"+(vv===v?" active-view":"");
  });renderAll();
}

function toggleSearch(){
  const bar=document.getElementById("search-bar");
  const visible=bar.classList.toggle("visible");
  if(visible) setTimeout(()=>document.getElementById("search-input").focus(),100);
  else{document.getElementById("search-input").value="";renderAll();}
}

function openModal(id){document.getElementById(id).style.display="flex";}
function closeModal(id){document.getElementById(id).style.display="none";}

let toastTimer=null;
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove("show"),2400);
}

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZE ‚Äî POWER ON SEQUENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GATE_PASSWORD="opencommand";
const GATE_DURATION=60*60*1000; // 60 minutes in ms

function checkPassword(){
  const input=document.getElementById("gate-input");
  const err=document.getElementById("gate-error");
  if(input.value===GATE_PASSWORD){
    localStorage.setItem("hub-auth",Date.now().toString());
    document.getElementById("gate").style.display="none";
    bootApp();
  } else {
    err.style.display="block";
    input.value="";
    input.style.borderColor="#FF2020";
    input.style.boxShadow="0 0 8px rgba(255,32,32,0.3)";
    setTimeout(()=>{
      err.style.display="none";
      input.style.borderColor="#B8860B";
      input.style.boxShadow="none";
    },2000);
    input.focus();
  }
}

async function bootApp(){
  document.getElementById("loading").style.display="flex";
  const lp=localStorage.getItem("hub-projects");
  const lt=localStorage.getItem("hub-tasks");
  if(lp) projects=JSON.parse(lp);
  if(lt) tasks=JSON.parse(lt);
  await loadAll();
  document.getElementById("loading").style.display="none";
  document.getElementById("app").style.display="flex";
  renderAll();
}

async function init(){
  const authTime=localStorage.getItem("hub-auth");
  const now=Date.now();
  if(authTime&&(now-parseInt(authTime))<GATE_DURATION){
    // Still within 60 min window ‚Äî skip gate
    document.getElementById("gate").style.display="none";
    await bootApp();
  } else {
    // Show gate
    localStorage.removeItem("hub-auth");
    document.getElementById("gate").style.display="flex";
    document.getElementById("loading").style.display="none";
    setTimeout(()=>document.getElementById("gate-input").focus(),300);
  }
}

window.addEventListener("online",()=>{showToast("GUILD ARCHIVES RESTORED ‚Äî SYNCING‚Ä¶");syncNow();});
window.addEventListener("offline",()=>{setSyncStatus("offline","SIGNAL LOST");showToast("SIGNAL LOST ‚Äî USING LOCAL TOMES");});

init();
</script>
</body>
</html>
